<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <title>Read Me A Story - AI Historie Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-M319LP9Z6P"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      // Konfigurer gtag til ikke at sende page_view automatisk, da vi h√•ndterer det efter cookie samtykke
      gtag('config', 'G-M319LP9Z6P', { 'send_page_view': false });
    </script>
</head>
<body>
    <header>
        <div class="logo-container">
            <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="Read Me A Story Logo" id="app-logo">
        </div>
        <div class="user-status">
            {% if current_user.is_authenticated %}
                <a href="{{ url_for('auth.logout') }}" class="button-logout utility-button">Log ud</a>
            {% else %}
                <a href="{{ url_for('auth.google_login') }}" class="button-login utility-button">Login med Google</a>
                <a href="{{ url_for('auth.email_password_login') }}" class="button-login utility-button" style="margin-left: 10px;">Log ind med E-mail</a>
            {% endif %}
        </div>
</header>

    <div class="tab-navigation">
        <button type="button" class="tab-button active" data-tab-target="#generator">Godnathistorier</button>
        <button type="button" class="tab-button" data-tab-target="#narrative-support-module">
                Narrativ St√∏tte
                {% if not current_user.is_authenticated or current_user.role != 'premium' %}
                    <span class="icon-lock" title="Kr√¶ver Premium medlemskab">üîí</span>
                {% endif %}
        </button>
    </div>
    <main>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages-container">
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">
                            {{ message }}
                            {% if category == 'info' and 'logget ud' in message %}
                                <p class="flash-disclaimer">(Bem√¶rk: Dit navn kan stadig v√¶re synligt i toppen indtil n√¶ste sideindl√¶sning.)</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <section id="generator" class="content-section">
            <h2>Byg jeres historie</h2>
            <p>(Det er ikke n√∏dvendigt at udfylde alle felterne.)</p>

            <div class="input-category">
                <label>Hvem skal historien l√¶ses for?</label>
                <div id="listener-container">
                    <div class="listener-group">
                        <div class="input-pair">
                           <label for="listener-name-1" class="sr-only">Navn</label>
                            <input type="text" name="listener_name_single" id="listener-name-1" placeholder="Barnets Navn">
                        </div>
                        <div class="input-pair">
                           <label for="listener-age-1" class="sr-only">Alder</label>
                            <input type="text" name="listener_age_single" id="listener-age-1" placeholder="Alder (f.eks. 5)">
                        </div>
                         <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                    </div>
                </div>
                <button type="button" id="add-listener-button" class="add-button">+ Tilf√∏j barn</button>
            </div>

            <div class="input-category">
                <label>Hvem skal v√¶re hovedperson(er)?</label>
                <div id="karakter-container">
                    <div class="character-group">
                         <div class="input-pair">
                            <label for="karakter-desc-1" class="sr-only">Beskrivelse</label>
                            <input type="text" name="karakter_desc" id="karakter-desc-1" placeholder="Beskrivelse (f.eks. en modig bi)">
                         </div>
                         <div class="input-pair">
                            <label for="karakter-navn-1" class="sr-only">Navn</label>
                            <input type="text" name="karakter_navn" id="karakter-navn-1" placeholder="Navn (valgfrit)">
                         </div>
                         <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                    </div>
                </div>
                <button type="button" id="add-karakter-button" class="add-button">+ Tilf√∏j karakter</button>
            </div>

            <div class="input-category">
                <label>Hvor skal historien foreg√•?</label>
                <div id="sted-container">
                     <div class="input-group">
                        <input type="text" name="sted" id="sted-input-1" placeholder="f.eks. i en kagebutik, p√• m√•nen">
                        <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                     </div>
                </div>
                <button type="button" class="add-button" data-container="sted-container" data-placeholder="f.eks. under en stor svamp" data-name="sted">+ Tilf√∏j sted</button>
            </div>

            <div class="input-category">
                <label>Ting, h√¶ndelser eller morale?</label>
                <div id="plot-container">
                    <div class="input-group">
                        <input type="text" name="plot" id="plot-input-1" placeholder="f.eks. en magisk fjer, 'at dele er godt'">
                        <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                    </div>
                </div>
                 <button type="button" class="add-button" data-container="plot-container" data-placeholder="f.eks. en hemmelig d√∏r, '√¶rlighed varer l√¶ngst'" data-name="plot">+ Tilf√∏j ting/morale</button>
            </div>

            <div class="input-category">
                <label for="negative-prompt-input">Ting der IKKE skal med i historien:</label>
                <div class="input-group"> <textarea id="negative-prompt-input" name="negative_prompt" rows="3" placeholder="f.eks. 'ingen edderkopper', 'undg√• monstre', 'ikke noget om at falde' (adskil med komma eller linjeskift)"></textarea>
                </div>
            </div>

            <div class="input-category">
                <label for="laengde-select">V√¶lg historie l√¶ngde:</label>
                <select name="laengde" id="laengde-select">
                    <option value="kort" selected>Kort</option>
                    <option value="mellem">Mellem</option>
                    <option value="lang">Lang</option>
                </select>
            </div>

            <div class="input-category">
                <label for="mood-select">V√¶lg stemning:</label>
                <select name="mood" id="mood-select">
                    <option value="neutral" selected>Neutral / Blandet</option>
                    <option value="s√∏d">S√∏d</option>
                    <option value="sjov">Sjov / Humoristisk</option>
                    <option value="eventyr">Eventyrlig</option>
                    <option value="sp√¶ndende">Sp√¶ndende</option>
                    <option value="rolig">Rolig / Afslappende</option>
                    <option value="mystisk">Mystisk</option>
                    <option value="hverdagsdrama">Hverdagsdrama (sm√• konflikter)</option>
                    <option value="uhyggelig">Uhyggelig</option>
                </select>
            </div>

            <div class="input-category">
                <label for="ai-model-switch" id="ai-model-main-label">Opgrader AI-Model (Bedre kvalitet, lidt langsommere):</label>
                <div class="ai-model-selector-wrapper">
                    <span class="ai-model-choice-label" id="ai-model-label-off">Off</span>
                    <div class="switch-container">
                        <input type="checkbox" id="ai-model-switch" name="ai_model_switch"
                               {% if not current_user.is_authenticated or current_user.role == 'free' %}
                               disabled
                               title="Denne funktion er kun tilg√¶ngelig for Basic og Premium brugere."
                               {% elif current_user.role in ['basic', 'premium'] %}
                               title="Sl√• til for at bruge Pro-modellen (h√∏jere kvalitet). 'Off' er standard."
                               {% endif %}>
                        <label for="ai-model-switch" class="slider-label"></label> {# Teksten er fjernet herfra #}
                    </div>
                    <span class="ai-model-choice-label" id="ai-model-label-on">On</span>
                </div>
                <small class="form-text text-muted" style="display: block; margin-top: 5px;">
                    {% if current_user.is_authenticated and current_user.role in ['basic', 'premium'] %}
                        'Off' bruger standard AI-modellen (hurtig), 'On' bruger Pro-modellen (h√∏jere kvalitet, kan v√¶re langsommere).
                    {% else %}
                        Premium og basic brugere kan v√¶lge en mere avanceret AI-model her ('On').
                        <br>(√ònskes adgang skriv til Philip, da dette alene er en mekanisme for at beskytte systemet mod uventet meget brug)
                    {% endif %}
                </small>
            </div>

            <div class="input-category checkbox-group hidden">
                <input type="checkbox" id="interactive-checkbox" name="interactive">
                <label for="interactive-checkbox">G√∏r historien til et inddragende eventyr (med valgmuligheder)?</label>
            </div>

            <div class="generator-actions">
                 <button type="button" id="autofill-button" class="utility-button">Autoudfyld</button>
                 <button type="button"
                        id="read-aloud-button"
                        class="utility-button tts-button {% if not current_user.is_authenticated %}disabled-button{% endif %}"
                        {% if not current_user.is_authenticated %}disabled title="Login for at aktivere funktionen"{% endif %}>
                    L√¶s Historien H√∏jt
                </button>
                <button type="button"
                        id="generate-image-button"
                        class="utility-button image-button"
                        disabled> Generer Billede
                </button>
                <div class="font-size-controls">
                    <button type="button" id="decrease-font-button" class="utility-button font-button" title="G√∏r teksten mindre">A-</button>
                    <button type="button" id="increase-font-button" class="utility-button font-button" title="G√∏r teksten st√∏rre">A+</button>
                    <button type="button" id="reset-font-button" class="utility-button font-button" title="Nulstil tekstst√∏rrelse">Nulstil</button>
                </div>
            </div>
            <button id="generate-button">Skab Historie</button>
        </section>

       <section id="narrative-support-module" class="content-section hidden">
            {% if current_user.is_authenticated and current_user.role == 'premium' %}
                {# --- START: FULD BRUGERFLADE FOR PREMIUM BRUGERE --- #}
                <h2>Narrativ St√∏tte</h2>
                <p>Skab historier med et specifikt p√¶dagogisk eller f√∏lelsesm√¶ssigt fokus.</p>

                <div class="narrative-info-dropdown">
                    <button type="button" class="dropdown-toggle">Hvad er Narrativ Terapi? <span class="dropdown-arrow">&#9664;</span></button>
                    <div class="dropdown-content hidden">
                        <p><em>(Detaljeret beskrivelse af narrativ terapi... (Dette indhold tilf√∏jes senere via "Modulbeskrivelse: Narrativ St√∏tte"))</em></p>
                    </div>
                </div>

                <div class="narrative-info-dropdown">
                    <button type="button" class="dropdown-toggle">Vejledning til Narrativ Historiefort√¶lling <span class="dropdown-arrow">&#9664;</span></button>
                    <div class="dropdown-content hidden">
                        <p><em>(Vejledning til for√¶ldre om effektiv udfyldning... (Dette indhold tilf√∏jes senere via "Modulbeskrivelse: Narrativ St√∏tte"))</em></p>
                    </div>
                </div>

                <div class="input-category">
                    <label for="narrative-focus-input">Tema, Udfordring eller Fokus for Historien (Obligatorisk):</label>
                    <textarea id="narrative-focus-input" name="narrative_focus" rows="3" placeholder="Eks: Min datter er bange for monstre under sengen, At l√¶re at sige undskyld, F√∏lelsen af at v√¶re genert..."></textarea>
                </div>
                <div class="input-category">
                    <label for="narrative-goal-input">√ònsket Udgang/M√•l for Historien (Anbefalet):</label>
                    <textarea id="narrative-goal-input" name="narrative_goal" rows="2" placeholder="Eks: At barnet f√∏ler sig mere modigt, At barnet l√¶rer at bede om hj√¶lp..."></textarea>
                </div>
                <div class="input-category">
                    <label>Information om Barnet (Hovedperson):</label>
                    <div id="narrative-child-info-container">
                        <div class="listener-group"> <div class="input-pair">
                               <label for="narrative-child-name-1" class="sr-only">Barnets Navn</label>
                                <input type="text" name="narrative_child_name" id="narrative-child-name-1" placeholder="Barnets Navn">
                            </div>
                            <div class="input-pair">
                               <label for="narrative-child-age-1" class="sr-only">Barnets Alder</label>
                                <input type="text" name="narrative_child_age" id="narrative-child-age-1" placeholder="Alder (f.eks. 6)">
                            </div>
                            </div>
                    </div>
                </div>
                <div class="input-category">
                    <label for="narrative-child-strengths-select">Barnets Karakteristika/Styrker (v√¶lg eller beskriv):</label>
                    <select name="narrative_child_strengths_select" id="narrative-child-strengths-select" class="dynamic-select" data-other-input-id="narrative-child-strengths-other">
                        <option value="">-- V√¶lg en styrke --</option><option value="Modig">Modig</option><option value="Klog">Klog</option><option value="Venlig">Venlig</option><option value="Kreativ">Kreativ</option><option value="T√•lmodig">T√•lmodig</option><option value="Nysgerrig">Nysgerrig</option><option value="Omsorgsfuld">Omsorgsfuld</option><option value="Sjov">Sjov</option><option value="St√¶rk">St√¶rk</option><option value="Fantasifuld">Fantasifuld</option><option value="Hj√¶lpsom">Hj√¶lpsom</option><option value="Vedholdende">Vedholdende</option><option value="other">Andet (beskriv nedenfor)...</option>
                    </select>
                    <input type="text" name="narrative_child_strengths_other" id="narrative-child-strengths-other" class="hidden other-input" placeholder="Beskriv anden styrke/karakteristik">
                </div>
                <div class="input-category">
                    <label for="narrative-child-values-select">Barnets V√¶rdier/Overbevisninger (valgfri):</label>
                    <select name="narrative_child_values_select" id="narrative-child-values-select" class="dynamic-select" data-other-input-id="narrative-child-values-other">
                        <option value="">-- V√¶lg en v√¶rdi --</option><option value="Retf√¶rdighed">Retf√¶rdighed</option><option value="√Ürlighed">√Ürlighed</option><option value="Empati">Empati</option><option value="Samarbejde">Samarbejde</option><option value="Frihed">Frihed</option><option value="Loyalitet">Loyalitet</option><option value="Omsorg">Omsorg</option><option value="At g√∏re sit bedste">At g√∏re sit bedste</option><option value="other">Andet (beskriv nedenfor)...</option>
                    </select>
                    <input type="text" name="narrative_child_values_other" id="narrative-child-values-other" class="hidden other-input" placeholder="Beskriv anden v√¶rdi/overbevisning">
                </div>
                <div class="input-category">
                    <label for="narrative-child-motivation">Barnets Motivation/√ònske (valgfri, udover problemfokus):</label>
                    <input type="text" id="narrative-child-motivation" name="narrative_child_motivation" placeholder="Eks: √ònsker at finde en ven, Vil gerne l√¶re at flyve...">
                </div>
                <div class="input-category">
                    <label for="narrative-child-reaction">Barnets Typiske Adf√¶rd/Reaktion p√• Udfordringen (valgfri):</label>
                    <textarea id="narrative-child-reaction" name="narrative_child_reaction" rows="2" placeholder="Eks: Tr√¶kker sig typisk tilbage, men vil gerne l√¶re at sige fra..."></textarea>
                </div>
                <div class="input-category">
                    <label>Vigtige Relationer for Barnet (valgfri):</label>
                    <div id="narrative-relations-container">
                        <div class="relation-group"> <div class="input-pair">
                               <label for="narrative-relation-name-1" class="sr-only">Relations Navn</label>
                                <input type="text" name="narrative_relation_name" id="narrative-relation-name-1" placeholder="Navn (f.eks. Bedstemor Anna)">
                            </div>
                            <div class="input-pair">
                               <label for="narrative-relation-type-1" class="sr-only">Relationstype</label>
                                <input type="text" name="narrative_relation_type" id="narrative-relation-type-1" placeholder="Relation (f.eks. Bedste ven, K√¶ledyr)">
                            </div>
                             <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                        </div>
                    </div>
                    <button type="button" id="narrative-add-relation-button" class="add-button">+ Tilf√∏j relation</button>
                </div>
                <div class="narrative-info-dropdown input-category"> <button type="button" class="dropdown-toggle">Beskriv Problem-Karakteren (Eksternalisering) <span class="dropdown-arrow">&#9664;</span></button>
                    <div class="dropdown-content hidden">
                        <div class="narrative-info-dropdown inner-dropdown" style="margin-bottom: 20px; border: 1px dashed var(--color-secondary); background-color: #fdfdfd;"> <button type="button" class="dropdown-toggle inner-dropdown-toggle" style="font-size: 0.9em; padding: 8px 12px;">Vejledning: Hvad er Eksternalisering? <span class="dropdown-arrow">&#9664;</span></button>
                            <div class="dropdown-content inner-dropdown-content hidden" style="padding: 10px 12px;">
                                <p style="font-size: 0.85em; line-height: 1.6;">Eksternalisering er et kerneprincip i narrativ terapi. Det handler om at adskille et problem eller en udfordring fra barnets identitet. I stedet for at sige "barnet *er* vredt", ser man vreden som noget ydre ‚Äì f.eks. en "Vredetrold", der kommer p√• bes√∏g.</p>
                                <ul style="font-size: 0.85em; line-height: 1.6; padding-left: 18px; margin-bottom: 0;">
                                    <li style="margin-bottom: 5px;"><strong>Giv problemet et navn/en form:</strong> Det g√∏r det lettere at tale om (f.eks. "Bekymringsmonsteret", "Sk√¶ldud-Skyen", "GenerthedsSp√∏gelset").</li>
                                    <li style="margin-bottom: 5px;"><strong>Adskil fra barnet:</strong> Problemet er noget, der p√•virker barnet, ikke noget barnet *er*.</li>
                                    <li style="margin-bottom: 5px;"><strong>√òget handlekraft:</strong> N√•r problemet er "udenfor", kan barnet bedre forholde sig til det, unders√∏ge det, og endda "forhandle" eller "k√¶mpe" med det.</li>
                                    <li style="margin-bottom: 0px;"><strong>Reducer skam/skyld:</strong> Det er ikke barnets skyld, at problemet er der.</li>
                                </ul>
                                <p style="font-size: 0.85em; line-height: 1.6; margin-top:10px;">N√•r du udfylder felterne nedenfor for "Problem-Karakteren", t√¶nk p√•, hvordan du kan give den udfordring, historien skal handle om, en s√•dan ydre form.</p>
                            </div>
                        </div>
                        <p style="font-size: 0.85em; color: #555; margin-top: 10px; margin-bottom: 15px;"><em>Dette hj√¶lper AI'en med at give "problemet" en ydre form i historien (f.eks. "Vredestrolden", "Generthedsskyggen"). Udfyld de felter, der giver mening for din historie.</em></p>
                        <div class="input-category" style="margin-bottom:15px;">
                            <label for="narrative-problem-identity-name">Problemets Navn/Identitet:</label>
                            <input type="text" id="narrative-problem-identity-name" name="narrative_problem_identity_name" placeholder="F.eks. Kede-Klodsen, Drille-Sp√∏gelset">
                        </div>

                        <div class="input-category" style="margin-bottom:15px;">
                            <label for="narrative-problem-role-function">Problemets Rolle/Funktion:</label>
                            <input type="text" id="narrative-problem-role-function" name="narrative_problem_role_function" placeholder="F.eks. dukker op n√•r ting er sv√¶re">
                        </div>

                        <div class="input-category" style="margin-bottom:15px;">
                            <label for="narrative-problem-purpose-intention">Problemets Form√•l/Intention:</label>
                            <input type="text" id="narrative-problem-purpose-intention" name="narrative_problem_purpose_intention" placeholder="F.eks. vil have al opm√¶rksomhed">
                        </div>

                        <div class="input-category" style="margin-bottom:15px;">
                            <label for="narrative-problem-behavior-action">Problemets Typiske Adf√¶rd/Handling:</label>
                            <input type="text" id="narrative-problem-behavior-action" name="narrative_problem_behavior_action" placeholder="F.eks. r√•ber h√∏jt, hvisker usynligt">
                        </div>

                        <div class="input-category" style="margin-bottom: 5px;"> <label for="narrative-problem-influence">Problemets Indflydelse p√• Hovedpersonen:</label>
                            <input type="text" id="narrative-problem-influence" name="narrative_problem_influence" placeholder="F.eks. g√∏r hovedpersonen ked af det">
                        </div>

                        <div style="margin-top: 15px; text-align: left;">
                            <button type="button" id="narrative-suggest-traits-button" class="utility-button">Foresl√• Karaktertr√¶k (AI)</button>
                        </div>
                    </div>
                </div>
                <hr style="margin: 30px 0;">
                <h4 style="margin-bottom: 15px;">Generelle Historieelementer (valgfri):</h4>
                <div class="input-category">
                    <label>Hovedkarakter(er) i Historien (udover barnets spejling):</label>
                    <div id="narrative-main-characters-container">
                        <div class="character-group">
                             <div class="input-pair">
                                <label for="narrative-main-char-desc-1" class="sr-only">Beskrivelse</label>
                                <input type="text" name="narrative_main_char_desc" id="narrative-main-char-desc-1" placeholder="Beskrivelse (f.eks. en talende r√¶v)">
                             </div>
                             <div class="input-pair">
                                <label for="narrative-main-char-name-1" class="sr-only">Navn</label>
                                <input type="text" name="narrative_main_char_name" id="narrative-main-char-name-1" placeholder="Navn (valgfrit)">
                             </div>
                             <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                        </div>
                    </div>
                    <button type="button" id="narrative-add-main-char-button" class="add-button">+ Tilf√∏j hovedkarakter</button>
                </div>
                <div class="input-category">
                    <label>Sted(er) hvor historien skal foreg√•:</label>
                    <div id="narrative-places-container">
                         <div class="input-group">
                            <label for="narrative-place-input-1" class="sr-only">Sted</label>
                            <input type="text" name="narrative_place" id="narrative-place-input-1" placeholder="f.eks. en hemmelig have, et rumskib">
                            <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                         </div>
                    </div>
                    <button type="button" class="add-button generic-add-button" data-container-id="narrative-places-container" data-input-name="narrative_place" data-input-placeholder="f.eks. under en regnbue" data-input-id-prefix="narrative-place-input">+ Tilf√∏j sted</button>
                </div>
                <div class="input-category">
                    <label>Plot-elementer eller √ònsket Morale for historien:</label>
                    <div id="narrative-plot-container">
                        <div class="input-group">
                            <label for="narrative-plot-input-1" class="sr-only">Plot/Morale</label>
                            <input type="text" name="narrative_plot" id="narrative-plot-input-1" placeholder="f.eks. en forsvundet skat, 'at v√¶re en god ven'">
                            <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                        </div>
                    </div>
                     <button type="button" class="add-button generic-add-button" data-container-id="narrative-plot-container" data-input-name="narrative_plot" data-input-placeholder="f.eks. en magisk konkurrence" data-input-id-prefix="narrative-plot-input">+ Tilf√∏j plot/morale</button>
                </div>
                <div class="input-category">
                    <label for="narrative-negative-prompt-input">Ting der IKKE skal med i historien:</label>
                    <div class="input-group"> <textarea id="narrative-negative-prompt-input" name="narrative_negative_prompt" rows="2" placeholder="f.eks. 'ingen hekse', 'undg√• at nogen gr√¶der'"></textarea>
                    </div>
                </div>
                <div class="input-category">
                    <label for="narrative-length-select">V√¶lg historie l√¶ngde:</label>
                    <select name="narrative_length" id="narrative-length-select">
                        <option value="kort">Kort</option>
                        <option value="mellem" selected>Mellem</option>
                        <option value="lang">Lang</option>
                    </select>
                </div>
                <div class="input-category">
                    <label for="narrative-mood-select">V√¶lg stemning:</label>
                    <select name="narrative_mood" id="narrative-mood-select">
                        <option value="neutral" selected>Neutral / Blandet</option>
                        <option value="h√•befuld">H√•befuld</option>
                        <option value="t√¶nksom">T√¶nksom</option>
                        <option value="magisk">Magisk</option>
                        <option value="eventyrlig">Eventyrlig</option>
                        <option value="rolig">Rolig / Afslappende</option>
                        <option value="sjov">Sjov / Humoristisk</option>
                    </select>
                </div>
                <hr style="margin: 30px 0;">

                <div class="narrative-actions" style="margin-top: 25px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                    <button type="button" id="narrative-generate-story-button" class="primary-action-button" style="background-color: var(--color-primary); color: white; font-size: 1.1em; padding: 12px 20px;">Generer Narrativ Historie</button>
                </div>

                <hr style="margin: 30px 0;">

                <div id="narrative-loading-indicator" class="narrative-loading-spinner hidden" style="margin-top: 20px;">
                    Genererer narrativ historie, vent venligst... <span class="spinner"></span>
                </div>
                <div id="narrative-error-display" class="flash-message flash-error hidden" style="margin-top: 20px;"></div>

                <section id="narrative-generated-story-section" class="narrative-output-section hidden">
                    <h2>Historien</h2>
                    <div id="narrative-generated-title" class="narrative-story-title"></div>
                    <div class="narrative-content-box">
                        <div id="narrative-generated-story" class="narrative-story-content-inner">
                            Vent venligst, eller tryk "Generer Narrativ Historie"...
                        </div>
                    </div>
                </section>

                <section id="narrative-reflection-section" class="narrative-output-section hidden">
                    <h2>Refleksionssp√∏rgsm√•l til Opl√¶seren</h2>
                    <div class="narrative-content-box">
                        <ul id="narrative-reflection-questions-list">
                            <li>Sp√∏rgsm√•l vises her efter generering.</li>
                        </ul>
                    </div>
                </section>

                <section id="narrative-debug-section" class="narrative-output-section narrative-info-dropdown hidden">
                    <button type="button" class="dropdown-toggle">
                        Teknisk Reference / Debug Information <span class="dropdown-arrow">&#9664;</span>
                    </button>
                    <div class="dropdown-content hidden">
                        <div class="debug-info-item">
                            <h3>Status:</h3>
                            <div class="narrative-content-box">
                                <pre id="narrative-debug-status">Venter p√• generering...</pre>
                            </div>
                        </div>
                        <div class="debug-info-item">
                            <h3>Narrativt Brief (AI Trin 1 Output):</h3>
                            <div class="narrative-content-box">
                                <pre id="narrative-debug-brief">Venter p√• generering...</pre>
                            </div>
                        </div>
                        <div class="debug-info-item">
                            <h3>Udkast Titel (AI Trin 2 Output):</h3>
                            <div class="narrative-content-box">
                                <pre id="narrative-debug-draft-title">Venter p√• generering...</pre>
                            </div>
                        </div>
                        <div class="debug-info-item">
                            <h3>Udkast Indhold (AI Trin 2 Output - Uddrag):</h3>
                            <div class="narrative-content-box">
                                <pre id="narrative-debug-draft-content">Venter p√• generering...</pre>
                            </div>
                        </div>
                    </div>
                </section>
                {# --- SLUT: FULD BRUGERFLADE FOR PREMIUM BRUGERE --- #}
            {% else %}
                {# --- START: INDIKATOR FOR IKKE-PREMIUM/IKKE-LOGGET IND BRUGERE --- #}
                <div class="premium-feature-notice" style="padding: 20px; text-align: center;">
                    <h2>
                        Narrativ St√∏tte
                        <span class="icon-lock" style="font-size: 0.8em;" title="Kr√¶ver test-login/udviklingsadgang">üîí</span>
                    </h2>

                    <p><strong>Denne funktion er under udvikling.</strong></p>
                    <p>For at f√• adgang til at skabe p√¶dagogisk og f√∏lelsesm√¶ssigt underst√∏ttende historier med "Narrativ St√∏tte"-modulet, kr√¶ves et specifikt test-login, da funktionen pt. er lukket for almindelige brugere, mens den testes og f√¶rdigudvikles.</p>

                    <p style="margin-top: 20px;">
                        <strong>Viden om Narrativ Terapi:</strong><br>
                        <a href="https://psykoterapeutforeningen.dk/psykoterapi/terapiretninger/narrativ-terapi" target="_blank" rel="noopener noreferrer">Beskrivelse af Narrativ Terapi (Psykoterapeutforeningen.dk)</a>
                    </p>

                    <p style="margin-top: 15px;">
                        <strong>Vil du gerne v√¶re med til at teste og udvikle dette modul?</strong><br>
                        S√• skriv til Philip
                    </p>

                    {# KORREKT BLOK TIL LOGIN/ROLLE VISNING #}
                    {% if not current_user.is_authenticated %}
                        <hr style="margin: 25px 0 15px 0;">
                        <p>For at bruge sidens √∏vrige funktioner kan du logge ind:</p>
                        <p style="margin-top: 10px;">
                            <a href="{{ url_for('auth.google_login') }}" class="button-login utility-button">Login med Google</a>
                            <a href="{{ url_for('auth.email_password_login') }}" class="button-login utility-button" style="margin-left: 10px;">Log ind med E-mail</a>
                        </p><!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <title>Read Me A Story - AI Historie Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-M319LP9Z6P"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      // Konfigurer gtag til ikke at sende page_view automatisk, da vi h√•ndterer det efter cookie samtykke
      gtag('config', 'G-M319LP9Z6P', { 'send_page_view': false });
    </script>
</head>
<body>
    <header>
        <div class="logo-container">
            <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="Read Me A Story Logo" id="app-logo">
        </div>
        <div class="user-status">
            {% if current_user.is_authenticated %}
                <a href="{{ url_for('auth.logout') }}" class="button-logout utility-button">Log ud</a>
            {% else %}
                <a href="{{ url_for('auth.google_login') }}" class="button-login utility-button">Login med Google</a>
                <a href="{{ url_for('auth.email_password_login') }}" class="button-login utility-button" style="margin-left: 10px;">Log ind med E-mail</a>
            {% endif %}
        </div>
</header>

    <div class="tab-navigation">
        <button type="button" class="tab-button active" data-tab-target="#generator">Godnathistorier</button>
        <button type="button" class="tab-button" data-tab-target="#narrative-support-module">
                Narrativ St√∏tte
                {% if not current_user.is_authenticated or current_user.role != 'premium' %}
                    <span class="icon-lock" title="Kr√¶ver Premium medlemskab">üîí</span>
                {% endif %}
        </button>
    </div>
    <main>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages-container">
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">
                            {{ message }}
                            {% if category == 'info' and 'logget ud' in message %}
                                <p class="flash-disclaimer">(Bem√¶rk: Dit navn kan stadig v√¶re synligt i toppen indtil n√¶ste sideindl√¶sning.)</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <section id="generator" class="content-section">
            <h2>Byg jeres historie</h2>
            <p>(Det er ikke n√∏dvendigt at udfylde alle felterne.)</p>

            <div class="input-category">
                <label>Hvem skal historien l√¶ses for?</label>
                <div id="listener-container">
                    <div class="listener-group">
                        <div class="input-pair">
                           <label for="listener-name-1" class="sr-only">Navn</label>
                            <input type="text" name="listener_name_single" id="listener-name-1" placeholder="Barnets Navn">
                        </div>
                        <div class="input-pair">
                           <label for="listener-age-1" class="sr-only">Alder</label>
                            <input type="text" name="listener_age_single" id="listener-age-1" placeholder="Alder (f.eks. 5)">
                        </div>
                         <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                    </div>
                </div>
                <button type="button" id="add-listener-button" class="add-button">+ Tilf√∏j barn</button>
            </div>

            <div class="input-category">
                <label>Hvem skal v√¶re hovedperson(er)?</label>
                <div id="karakter-container">
                    <div class="character-group">
                         <div class="input-pair">
                            <label for="karakter-desc-1" class="sr-only">Beskrivelse</label>
                            <input type="text" name="karakter_desc" id="karakter-desc-1" placeholder="Beskrivelse (f.eks. en modig bi)">
                         </div>
                         <div class="input-pair">
                            <label for="karakter-navn-1" class="sr-only">Navn</label>
                            <input type="text" name="karakter_navn" id="karakter-navn-1" placeholder="Navn (valgfrit)">
                         </div>
                         <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                    </div>
                </div>
                <button type="button" id="add-karakter-button" class="add-button">+ Tilf√∏j karakter</button>
            </div>

            <div class="input-category">
                <label>Hvor skal historien foreg√•?</label>
                <div id="sted-container">
                     <div class="input-group">
                        <input type="text" name="sted" id="sted-input-1" placeholder="f.eks. i en kagebutik, p√• m√•nen">
                        <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                     </div>
                </div>
                <button type="button" class="add-button" data-container="sted-container" data-placeholder="f.eks. under en stor svamp" data-name="sted">+ Tilf√∏j sted</button>
            </div>

            <div class="input-category">
                <label>Ting, h√¶ndelser eller morale?</label>
                <div id="plot-container">
                    <div class="input-group">
                        <input type="text" name="plot" id="plot-input-1" placeholder="f.eks. en magisk fjer, 'at dele er godt'">
                        <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                    </div>
                </div>
                 <button type="button" class="add-button" data-container="plot-container" data-placeholder="f.eks. en hemmelig d√∏r, '√¶rlighed varer l√¶ngst'" data-name="plot">+ Tilf√∏j ting/morale</button>
            </div>

            <div class="input-category">
                <label for="negative-prompt-input">Ting der IKKE skal med i historien:</label>
                <div class="input-group"> <textarea id="negative-prompt-input" name="negative_prompt" rows="3" placeholder="f.eks. 'ingen edderkopper', 'undg√• monstre', 'ikke noget om at falde' (adskil med komma eller linjeskift)"></textarea>
                </div>
            </div>

            <div class="input-category">
                <label for="laengde-select">V√¶lg historie l√¶ngde:</label>
                <select name="laengde" id="laengde-select">
                    <option value="kort" selected>Kort</option>
                    <option value="mellem">Mellem</option>
                    <option value="lang">Lang</option>
                </select>
            </div>

            <div class="input-category">
                <label for="mood-select">V√¶lg stemning:</label>
                <select name="mood" id="mood-select">
                    <option value="neutral" selected>Neutral / Blandet</option>
                    <option value="s√∏d">S√∏d</option>
                    <option value="sjov">Sjov / Humoristisk</option>
                    <option value="eventyr">Eventyrlig</option>
                    <option value="sp√¶ndende">Sp√¶ndende</option>
                    <option value="rolig">Rolig / Afslappende</option>
                    <option value="mystisk">Mystisk</option>
                    <option value="hverdagsdrama">Hverdagsdrama (sm√• konflikter)</option>
                    <option value="uhyggelig">Uhyggelig</option>
                </select>
            </div>

            <div class="input-category">
                <label for="ai-model-switch" id="ai-model-main-label">Opgrader AI-Model (Bedre kvalitet, lidt langsommere):</label>
                <div class="ai-model-selector-wrapper">
                    <span class="ai-model-choice-label" id="ai-model-label-off">Off</span>
                    <div class="switch-container">
                        <input type="checkbox" id="ai-model-switch" name="ai_model_switch"
                               {% if not current_user.is_authenticated or current_user.role == 'free' %}
                               disabled
                               title="Denne funktion er kun tilg√¶ngelig for Basic og Premium brugere."
                               {% elif current_user.role in ['basic', 'premium'] %}
                               title="Sl√• til for at bruge Pro-modellen (h√∏jere kvalitet). 'Off' er standard."
                               {% endif %}>
                        <label for="ai-model-switch" class="slider-label"></label> {# Teksten er fjernet herfra #}
                    </div>
                    <span class="ai-model-choice-label" id="ai-model-label-on">On</span>
                </div>
                <small class="form-text text-muted" style="display: block; margin-top: 5px;">
                    {% if current_user.is_authenticated and current_user.role in ['basic', 'premium'] %}
                        'Off' bruger standard AI-modellen (hurtig), 'On' bruger Pro-modellen (h√∏jere kvalitet, kan v√¶re langsommere).
                    {% else %}
                        Premium og basic brugere kan v√¶lge en mere avanceret AI-model her ('On').
                        <br>(√ònskes adgang skriv til Philip, da dette alene er en mekanisme for at beskytte systemet mod uventet meget brug)
                    {% endif %}
                </small>
            </div>

            <div class="input-category checkbox-group hidden">
                <input type="checkbox" id="interactive-checkbox" name="interactive">
                <label for="interactive-checkbox">G√∏r historien til et inddragende eventyr (med valgmuligheder)?</label>
            </div>

            <div class="generator-actions">
                 <button type="button" id="autofill-button" class="utility-button">Autoudfyld</button>
                 <button type="button"
                        id="read-aloud-button"
                        class="utility-button tts-button {% if not current_user.is_authenticated %}disabled-button{% endif %}"
                        {% if not current_user.is_authenticated %}disabled title="Login for at aktivere funktionen"{% endif %}>
                    L√¶s Historien H√∏jt
                </button>
                <button type="button"
                        id="generate-image-button"
                        class="utility-button image-button"
                        disabled> Generer Billede
                </button>
            </div>
            <button id="generate-button">Skab Historie</button>
        </section>

       <section id="narrative-support-module" class="content-section hidden">
            {% if current_user.is_authenticated and current_user.role == 'premium' %}
                {# --- START: FULD BRUGERFLADE FOR PREMIUM BRUGERE --- #}
                <h2>Narrativ St√∏tte</h2>
                <p>Skab historier med et specifikt p√¶dagogisk eller f√∏lelsesm√¶ssigt fokus.</p>

                <div class="narrative-info-dropdown">
                    <button type="button" class="dropdown-toggle">Hvad er Narrativ Terapi? <span class="dropdown-arrow">&#9664;</span></button>
                    <div class="dropdown-content hidden">
                        <p><em>(Detaljeret beskrivelse af narrativ terapi... (Dette indhold tilf√∏jes senere via "Modulbeskrivelse: Narrativ St√∏tte"))</em></p>
                    </div>
                </div>

                <div class="narrative-info-dropdown">
                    <button type="button" class="dropdown-toggle">Vejledning til Narrativ Historiefort√¶lling <span class="dropdown-arrow">&#9664;</span></button>
                    <div class="dropdown-content hidden">
                        <p><em>(Vejledning til for√¶ldre om effektiv udfyldning... (Dette indhold tilf√∏jes senere via "Modulbeskrivelse: Narrativ St√∏tte"))</em></p>
                    </div>
                </div>

                <div class="input-category">
                    <label for="narrative-focus-input">Tema, Udfordring eller Fokus for Historien (Obligatorisk):</label>
                    <textarea id="narrative-focus-input" name="narrative_focus" rows="3" placeholder="Eks: Min datter er bange for monstre under sengen, At l√¶re at sige undskyld, F√∏lelsen af at v√¶re genert..."></textarea>
                </div>
                <div class="input-category">
                    <label for="narrative-goal-input">√ònsket Udgang/M√•l for Historien (Anbefalet):</label>
                    <textarea id="narrative-goal-input" name="narrative_goal" rows="2" placeholder="Eks: At barnet f√∏ler sig mere modigt, At barnet l√¶rer at bede om hj√¶lp..."></textarea>
                </div>
                <div class="input-category">
                    <label>Information om Barnet (Hovedperson):</label>
                    <div id="narrative-child-info-container">
                        <div class="listener-group"> <div class="input-pair">
                               <label for="narrative-child-name-1" class="sr-only">Barnets Navn</label>
                                <input type="text" name="narrative_child_name" id="narrative-child-name-1" placeholder="Barnets Navn">
                            </div>
                            <div class="input-pair">
                               <label for="narrative-child-age-1" class="sr-only">Barnets Alder</label>
                                <input type="text" name="narrative_child_age" id="narrative-child-age-1" placeholder="Alder (f.eks. 6)">
                            </div>
                            </div>
                    </div>
                </div>
                <div class="input-category">
                    <label for="narrative-child-strengths-select">Barnets Karakteristika/Styrker (v√¶lg eller beskriv):</label>
                    <select name="narrative_child_strengths_select" id="narrative-child-strengths-select" class="dynamic-select" data-other-input-id="narrative-child-strengths-other">
                        <option value="">-- V√¶lg en styrke --</option><option value="Modig">Modig</option><option value="Klog">Klog</option><option value="Venlig">Venlig</option><option value="Kreativ">Kreativ</option><option value="T√•lmodig">T√•lmodig</option><option value="Nysgerrig">Nysgerrig</option><option value="Omsorgsfuld">Omsorgsfuld</option><option value="Sjov">Sjov</option><option value="St√¶rk">St√¶rk</option><option value="Fantasifuld">Fantasifuld</option><option value="Hj√¶lpsom">Hj√¶lpsom</option><option value="Vedholdende">Vedholdende</option><option value="other">Andet (beskriv nedenfor)...</option>
                    </select>
                    <input type="text" name="narrative_child_strengths_other" id="narrative-child-strengths-other" class="hidden other-input" placeholder="Beskriv anden styrke/karakteristik">
                </div>
                <div class="input-category">
                    <label for="narrative-child-values-select">Barnets V√¶rdier/Overbevisninger (valgfri):</label>
                    <select name="narrative_child_values_select" id="narrative-child-values-select" class="dynamic-select" data-other-input-id="narrative-child-values-other">
                        <option value="">-- V√¶lg en v√¶rdi --</option><option value="Retf√¶rdighed">Retf√¶rdighed</option><option value="√Ürlighed">√Ürlighed</option><option value="Empati">Empati</option><option value="Samarbejde">Samarbejde</option><option value="Frihed">Frihed</option><option value="Loyalitet">Loyalitet</option><option value="Omsorg">Omsorg</option><option value="At g√∏re sit bedste">At g√∏re sit bedste</option><option value="other">Andet (beskriv nedenfor)...</option>
                    </select>
                    <input type="text" name="narrative_child_values_other" id="narrative-child-values-other" class="hidden other-input" placeholder="Beskriv anden v√¶rdi/overbevisning">
                </div>
                <div class="input-category">
                    <label for="narrative-child-motivation">Barnets Motivation/√ònske (valgfri, udover problemfokus):</label>
                    <input type="text" id="narrative-child-motivation" name="narrative_child_motivation" placeholder="Eks: √ònsker at finde en ven, Vil gerne l√¶re at flyve...">
                </div>
                <div class="input-category">
                    <label for="narrative-child-reaction">Barnets Typiske Adf√¶rd/Reaktion p√• Udfordringen (valgfri):</label>
                    <textarea id="narrative-child-reaction" name="narrative_child_reaction" rows="2" placeholder="Eks: Tr√¶kker sig typisk tilbage, men vil gerne l√¶re at sige fra..."></textarea>
                </div>
                <div class="input-category">
                    <label>Vigtige Relationer for Barnet (valgfri):</label>
                    <div id="narrative-relations-container">
                        <div class="relation-group"> <div class="input-pair">
                               <label for="narrative-relation-name-1" class="sr-only">Relations Navn</label>
                                <input type="text" name="narrative_relation_name" id="narrative-relation-name-1" placeholder="Navn (f.eks. Bedstemor Anna)">
                            </div>
                            <div class="input-pair">
                               <label for="narrative-relation-type-1" class="sr-only">Relationstype</label>
                                <input type="text" name="narrative_relation_type" id="narrative-relation-type-1" placeholder="Relation (f.eks. Bedste ven, K√¶ledyr)">
                            </div>
                             <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                        </div>
                    </div>
                    <button type="button" id="narrative-add-relation-button" class="add-button">+ Tilf√∏j relation</button>
                </div>
                <div class="narrative-info-dropdown input-category"> <button type="button" class="dropdown-toggle">Beskriv Problem-Karakteren (Eksternalisering) <span class="dropdown-arrow">&#9664;</span></button>
                    <div class="dropdown-content hidden">
                        <div class="narrative-info-dropdown inner-dropdown" style="margin-bottom: 20px; border: 1px dashed var(--color-secondary); background-color: #fdfdfd;"> <button type="button" class="dropdown-toggle inner-dropdown-toggle" style="font-size: 0.9em; padding: 8px 12px;">Vejledning: Hvad er Eksternalisering? <span class="dropdown-arrow">&#9664;</span></button>
                            <div class="dropdown-content inner-dropdown-content hidden" style="padding: 10px 12px;">
                                <p style="font-size: 0.85em; line-height: 1.6;">Eksternalisering er et kerneprincip i narrativ terapi. Det handler om at adskille et problem eller en udfordring fra barnets identitet. I stedet for at sige "barnet *er* vredt", ser man vreden som noget ydre ‚Äì f.eks. en "Vredetrold", der kommer p√• bes√∏g.</p>
                                <ul style="font-size: 0.85em; line-height: 1.6; padding-left: 18px; margin-bottom: 0;">
                                    <li style="margin-bottom: 5px;"><strong>Giv problemet et navn/en form:</strong> Det g√∏r det lettere at tale om (f.eks. "Bekymringsmonsteret", "Sk√¶ldud-Skyen", "GenerthedsSp√∏gelset").</li>
                                    <li style="margin-bottom: 5px;"><strong>Adskil fra barnet:</strong> Problemet er noget, der p√•virker barnet, ikke noget barnet *er*.</li>
                                    <li style="margin-bottom: 5px;"><strong>√òget handlekraft:</strong> N√•r problemet er "udenfor", kan barnet bedre forholde sig til det, unders√∏ge det, og endda "forhandle" eller "k√¶mpe" med det.</li>
                                    <li style="margin-bottom: 0px;"><strong>Reducer skam/skyld:</strong> Det er ikke barnets skyld, at problemet er der.</li>
                                </ul>
                                <p style="font-size: 0.85em; line-height: 1.6; margin-top:10px;">N√•r du udfylder felterne nedenfor for "Problem-Karakteren", t√¶nk p√•, hvordan du kan give den udfordring, historien skal handle om, en s√•dan ydre form.</p>
                            </div>
                        </div>
                        <p style="font-size: 0.85em; color: #555; margin-top: 10px; margin-bottom: 15px;"><em>Dette hj√¶lper AI'en med at give "problemet" en ydre form i historien (f.eks. "Vredestrolden", "Generthedsskyggen"). Udfyld de felter, der giver mening for din historie.</em></p>
                        <div class="input-category" style="margin-bottom:15px;">
                            <label for="narrative-problem-identity-name">Problemets Navn/Identitet:</label>
                            <input type="text" id="narrative-problem-identity-name" name="narrative_problem_identity_name" placeholder="F.eks. Kede-Klodsen, Drille-Sp√∏gelset">
                        </div>

                        <div class="input-category" style="margin-bottom:15px;">
                            <label for="narrative-problem-role-function">Problemets Rolle/Funktion:</label>
                            <input type="text" id="narrative-problem-role-function" name="narrative_problem_role_function" placeholder="F.eks. dukker op n√•r ting er sv√¶re">
                        </div>

                        <div class="input-category" style="margin-bottom:15px;">
                            <label for="narrative-problem-purpose-intention">Problemets Form√•l/Intention:</label>
                            <input type="text" id="narrative-problem-purpose-intention" name="narrative_problem_purpose_intention" placeholder="F.eks. vil have al opm√¶rksomhed">
                        </div>

                        <div class="input-category" style="margin-bottom:15px;">
                            <label for="narrative-problem-behavior-action">Problemets Typiske Adf√¶rd/Handling:</label>
                            <input type="text" id="narrative-problem-behavior-action" name="narrative_problem_behavior_action" placeholder="F.eks. r√•ber h√∏jt, hvisker usynligt">
                        </div>

                        <div class="input-category" style="margin-bottom: 5px;"> <label for="narrative-problem-influence">Problemets Indflydelse p√• Hovedpersonen:</label>
                            <input type="text" id="narrative-problem-influence" name="narrative_problem_influence" placeholder="F.eks. g√∏r hovedpersonen ked af det">
                        </div>

                        <div style="margin-top: 15px; text-align: left;">
                            <button type="button" id="narrative-suggest-traits-button" class="utility-button">Foresl√• Karaktertr√¶k (AI)</button>
                        </div>
                    </div>
                </div>
                <hr style="margin: 30px 0;">
                <h4 style="margin-bottom: 15px;">Generelle Historieelementer (valgfri):</h4>
                <div class="input-category">
                    <label>Hovedkarakter(er) i Historien (udover barnets spejling):</label>
                    <div id="narrative-main-characters-container">
                        <div class="character-group">
                             <div class="input-pair">
                                <label for="narrative-main-char-desc-1" class="sr-only">Beskrivelse</label>
                                <input type="text" name="narrative_main_char_desc" id="narrative-main-char-desc-1" placeholder="Beskrivelse (f.eks. en talende r√¶v)">
                             </div>
                             <div class="input-pair">
                                <label for="narrative-main-char-name-1" class="sr-only">Navn</label>
                                <input type="text" name="narrative_main_char_name" id="narrative-main-char-name-1" placeholder="Navn (valgfrit)">
                             </div>
                             <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                        </div>
                    </div>
                    <button type="button" id="narrative-add-main-char-button" class="add-button">+ Tilf√∏j hovedkarakter</button>
                </div>
                <div class="input-category">
                    <label>Sted(er) hvor historien skal foreg√•:</label>
                    <div id="narrative-places-container">
                         <div class="input-group">
                            <label for="narrative-place-input-1" class="sr-only">Sted</label>
                            <input type="text" name="narrative_place" id="narrative-place-input-1" placeholder="f.eks. en hemmelig have, et rumskib">
                            <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                         </div>
                    </div>
                    <button type="button" class="add-button generic-add-button" data-container-id="narrative-places-container" data-input-name="narrative_place" data-input-placeholder="f.eks. under en regnbue" data-input-id-prefix="narrative-place-input">+ Tilf√∏j sted</button>
                </div>
                <div class="input-category">
                    <label>Plot-elementer eller √ònsket Morale for historien:</label>
                    <div id="narrative-plot-container">
                        <div class="input-group">
                            <label for="narrative-plot-input-1" class="sr-only">Plot/Morale</label>
                            <input type="text" name="narrative_plot" id="narrative-plot-input-1" placeholder="f.eks. en forsvundet skat, 'at v√¶re en god ven'">
                            <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                        </div>
                    </div>
                     <button type="button" class="add-button generic-add-button" data-container-id="narrative-plot-container" data-input-name="narrative_plot" data-input-placeholder="f.eks. en magisk konkurrence" data-input-id-prefix="narrative-plot-input">+ Tilf√∏j plot/morale</button>
                </div>
                <div class="input-category">
                    <label for="narrative-negative-prompt-input">Ting der IKKE skal med i historien:</label>
                    <div class="input-group"> <textarea id="narrative-negative-prompt-input" name="narrative_negative_prompt" rows="2" placeholder="f.eks. 'ingen hekse', 'undg√• at nogen gr√¶der'"></textarea>
                    </div>
                </div>
                <div class="input-category">
                    <label for="narrative-length-select">V√¶lg historie l√¶ngde:</label>
                    <select name="narrative_length" id="narrative-length-select">
                        <option value="kort">Kort</option>
                        <option value="mellem" selected>Mellem</option>
                        <option value="lang">Lang</option>
                    </select>
                </div>
                <div class="input-category">
                    <label for="narrative-mood-select">V√¶lg stemning:</label>
                    <select name="narrative_mood" id="narrative-mood-select">
                        <option value="neutral" selected>Neutral / Blandet</option>
                        <option value="h√•befuld">H√•befuld</option>
                        <option value="t√¶nksom">T√¶nksom</option>
                        <option value="magisk">Magisk</option>
                        <option value="eventyrlig">Eventyrlig</option>
                        <option value="rolig">Rolig / Afslappende</option>
                        <option value="sjov">Sjov / Humoristisk</option>
                    </select>
                </div>
                <hr style="margin: 30px 0;">

                <div class="narrative-actions" style="margin-top: 25px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                    <button type="button" id="narrative-generate-story-button" class="primary-action-button" style="background-color: var(--color-primary); color: white; font-size: 1.1em; padding: 12px 20px;">Generer Narrativ Historie</button>
                <div class="font-size-controls" id="narrative-font-size-controls">
                    <button type="button" id="narrative-decrease-font-button" class="utility-button font-button" title="G√∏r teksten mindre">A-</button>
                    <button type="button" id="narrative-increase-font-button" class="utility-button font-button" title="G√∏r teksten st√∏rre">A+</button>
                    <button type="button" id="narrative-reset-font-button" class="utility-button font-button" title="Nulstil tekstst√∏rrelse">Nulstil</button>
                </div>
                </div>

                <hr style="margin: 30px 0;">

                <div id="narrative-loading-indicator" class="narrative-loading-spinner hidden" style="margin-top: 20px;">
                    Genererer narrativ historie, vent venligst... <span class="spinner"></span>
                </div>
                </div>

                <hr style="margin: 30px 0;">

                <div id="narrative-loading-indicator" class="narrative-loading-spinner hidden" style="margin-top: 20px;">
                    Genererer narrativ historie, vent venligst... <span class="spinner"></span>
                </div>
                <div id="narrative-error-display" class="flash-message flash-error hidden" style="margin-top: 20px;"></div>

                <section id="narrative-generated-story-section" class="narrative-output-section hidden">
                    <h2>Historien</h2>
                    <div id="narrative-generated-title" class="narrative-story-title"></div>
                    <div class="narrative-content-box">
                        <div id="narrative-generated-story" class="narrative-story-content-inner">
                            Vent venligst, eller tryk "Generer Narrativ Historie"...
                        </div>
                    </div>
                </section>

                <section id="narrative-reflection-section" class="narrative-output-section hidden">
                    <h2>Refleksionssp√∏rgsm√•l til Opl√¶seren</h2>
                    <div class="narrative-content-box">
                        <ul id="narrative-reflection-questions-list">
                            <li>Sp√∏rgsm√•l vises her efter generering.</li>
                        </ul>
                    </div>
                </section>

                <section id="narrative-debug-section" class="narrative-output-section narrative-info-dropdown hidden">
                    <button type="button" class="dropdown-toggle">
                        Teknisk Reference / Debug Information <span class="dropdown-arrow">&#9664;</span>
                    </button>
                    <div class="dropdown-content hidden">
                        <div class="debug-info-item">
                            <h3>Status:</h3>
                            <div class="narrative-content-box">
                                <pre id="narrative-debug-status">Venter p√• generering...</pre>
                            </div>
                        </div>
                        <div class="debug-info-item">
                            <h3>Narrativt Brief (AI Trin 1 Output):</h3>
                            <div class="narrative-content-box">
                                <pre id="narrative-debug-brief">Venter p√• generering...</pre>
                            </div>
                        </div>
                        <div class="debug-info-item">
                            <h3>Udkast Titel (AI Trin 2 Output):</h3>
                            <div class="narrative-content-box">
                                <pre id="narrative-debug-draft-title">Venter p√• generering...</pre>
                            </div>
                        </div>
                        <div class="debug-info-item">
                            <h3>Udkast Indhold (AI Trin 2 Output - Uddrag):</h3>
                            <div class="narrative-content-box">
                                <pre id="narrative-debug-draft-content">Venter p√• generering...</pre>
                            </div>
                        </div>
                    </div>
                </section>
                {# --- SLUT: FULD BRUGERFLADE FOR PREMIUM BRUGERE --- #}
            {% else %}
                {# --- START: INDIKATOR FOR IKKE-PREMIUM/IKKE-LOGGET IND BRUGERE --- #}
                <div class="premium-feature-notice" style="padding: 20px; text-align: center;">
                    <h2>
                        Narrativ St√∏tte
                        <span class="icon-lock" style="font-size: 0.8em;" title="Kr√¶ver test-login/udviklingsadgang">üîí</span>
                    </h2>

                    <p><strong>Denne funktion er under udvikling.</strong></p>
                    <p>For at f√• adgang til at skabe p√¶dagogisk og f√∏lelsesm√¶ssigt underst√∏ttende historier med "Narrativ St√∏tte"-modulet, kr√¶ves et specifikt test-login, da funktionen pt. er lukket for almindelige brugere, mens den testes og f√¶rdigudvikles.</p>

                    <p style="margin-top: 20px;">
                        <strong>Viden om Narrativ Terapi:</strong><br>
                        <a href="https://psykoterapeutforeningen.dk/psykoterapi/terapiretninger/narrativ-terapi" target="_blank" rel="noopener noreferrer">Beskrivelse af Narrativ Terapi (Psykoterapeutforeningen.dk)</a>
                    </p>

                    <p style="margin-top: 15px;">
                        <strong>Vil du gerne v√¶re med til at teste og udvikle dette modul?</strong><br>
                        S√• skriv til Philip
                    </p>

                    {# KORREKT BLOK TIL LOGIN/ROLLE VISNING #}
                    {% if not current_user.is_authenticated %}
                        <hr style="margin: 25px 0 15px 0;">
                        <p>For at bruge sidens √∏vrige funktioner kan du logge ind:</p>
                        <p style="margin-top: 10px;">
                            <a href="{{ url_for('auth.google_login') }}" class="button-login utility-button">Login med Google</a>
                            <a href="{{ url_for('auth.email_password_login') }}" class="button-login utility-button" style="margin-left: 10px;">Log ind med E-mail</a>
                        </p>
                    {% else %}
                        {# Brugeren ER logget ind, men ikke premium (derfor er vi i denne ydre 'else' blok for narrative-support) #}
                        {# Vi tjekker specifikt for 'free' eller 'basic' her for at give en relevant besked #}
                        {% if current_user.role == 'free' or current_user.role == 'basic' %}
                            <p style="margin-top: 15px;">Din nuv√¶rende rolle er '{{ current_user.role | capitalize }}'. Adgang til Narrativ St√∏tte kr√¶ver Premium.</p>
                        {% endif %}
                    {% endif %}
                    {# SLUT P√Ö KORREKT BLOK TIL LOGIN/ROLLE VISNING #}

                    <p style="margin-top:25px; font-size:0.9em; border-top: 1px solid #eee; padding-top: 15px;">
                        <em>Du kan stadig bruge den almindelige
                            <a href="#" onclick="document.querySelector('.tab-button[data-tab-target=\'#generator\']').click(); return false;">"Godnathistorier"-generator</a>.
                        </em>
                    </p>
                </div>
                {# --- SLUT: INDIKATOR FOR IKKE-PREMIUM/IKKE-LOGGET IND BRUGERE --- #}
            {% endif %} {# Dette er endif for den YDRE if current_user.is_authenticated and current_user.role == 'premium' #}
        </section>
    </main>

    <div id="cookie-consent-banner" class="hidden">
        <p>Denne side bruger cookies til at forbedre din oplevelse og til analyseform√•l (Google Analytics). Ved at klikke "Accepter" giver du samtykke til brugen af disse cookies. L√¶s mere i vores <a href="{{ url_for('main.privacy_policy') }}">privatlivspolitik</a>.</p>
        <button id="accept-cookies-button" class="utility-button">Accepter</button>
    </div>

    <footer>
        <hr>
        <div class="footer-content">
        <div class="footer-info">
                <p>¬© Read Me A Story 2025 - Historier skabt med AI.</p>
                <p><i>For√¶ldreopsyn anbefales altid under l√¶sning. ;)</i></p>
                <p><a href="{{ url_for('main.privacy_policy') }}" class="footer-link">Privatlivs- og Cookiepolitik</a></p> </div>
            </div>
            <div class="footer-social">
                <p>F√∏lg & Del Appen:</p>
                <a href="https://www.facebook.com/profile.php?id=61576301092618" target="_blank" rel="noopener noreferrer" class="social-link">Find os p√• Facebook</a>
                <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.url_root.strip('/') | urlencode }}" target="_blank" rel="noopener noreferrer" class="social-link">Del p√• LinkedIn</a>
            </div>
        </div>
    </footer>

    <script type="module" src="{{ url_for('static', filename='script.js') }}"></script>

</body>
</html>
                    {% else %}
                        {# Brugeren ER logget ind, men ikke premium (derfor er vi i denne ydre 'else' blok for narrative-support) #}
                        {# Vi tjekker specifikt for 'free' eller 'basic' her for at give en relevant besked #}
                        {% if current_user.role == 'free' or current_user.role == 'basic' %}
                            <p style="margin-top: 15px;">Din nuv√¶rende rolle er '{{ current_user.role | capitalize }}'. Adgang til Narrativ St√∏tte kr√¶ver Premium.</p>
                        {% endif %}
                    {% endif %}
                    {# SLUT P√Ö KORREKT BLOK TIL LOGIN/ROLLE VISNING #}

                    <p style="margin-top:25px; font-size:0.9em; border-top: 1px solid #eee; padding-top: 15px;">
                        <em>Du kan stadig bruge den almindelige
                            <a href="#" onclick="document.querySelector('.tab-button[data-tab-target=\'#generator\']').click(); return false;">"Godnathistorier"-generator</a>.
                        </em>
                    </p>
                </div>
                {# --- SLUT: INDIKATOR FOR IKKE-PREMIUM/IKKE-LOGGET IND BRUGERE --- #}
            {% endif %} {# Dette er endif for den YDRE if current_user.is_authenticated and current_user.role == 'premium' #}
        </section>
        <section id="historie-output">
            <div class="historie-header-controls">
                <h2 id="story-section-heading">Jeres historie</h2>
                <div class="audio-controls-container">
                    <div id="audio-loading" class="hidden">Genererer lyd, vent venligst... <span class="spinner"></span></div>
                    <div id="audio-error" class="feedback-status error"></div>
                    <div class="login-prompt hidden" id="login-prompt-audio">
                        <em>Du skal v√¶re <a href="{{ url_for('auth.google_login') }}">logget ind</a> for at f√• l√¶st historien h√∏jt.</em>
                    </div>
                </div>
                <audio id="audio-player" controls class="audio-player-style hidden">
                    Din browser underst√∏tter ikke lyd-elementet.
                </audio>
            </div>
            <div id="story-display"></div>
            <div id="story-share-buttons" class="hidden">
                <button type="button" id="share-story-facebook-button" class="utility-button">Del denne historie p√• Facebook</button>
                <button type="button" id="copy-story-button" class="utility-button">Kopier historie til deling</button>
                <button id="reset-button" class="utility-button" style="display: none;">Pr√∏v Igen</button>
            </div>
            <div class="info-dropdown-container" style="margin-top: 20px; text-align: left; max-width: 100%;">
                <button type="button" class="dropdown-toggle" id="failure-info-dropdown-toggle">
                    Hvorfor fejler min historie/billede nogle gange? <span class="dropdown-arrow">&#9664;</span>
                </button>
                <div id="failure-info-dropdown-content" class="dropdown-content hidden" style="padding: 12px 15px; border-top: 1px solid var(--border-color); background-color: #fcfcfc;">
                    <p><strong>Mulige √•rsager til at AI-generering kan fejle:</strong></p>
                    <ul style="margin-top: 8px; padding-left: 20px;">
                        <li style="margin-bottom: 8px;">
                            <strong>For billeder:</strong>
                            <ul style="list-style-type: circle; margin-top: 4px; padding-left: 20px;">
                                <li style="margin-bottom: 4px;">AI-modellerne har pt. stramme restriktioner og politikker, der fx forhindrer generering af billeder, som indeholder genkendelige b√∏rn. Derfor pr√∏ver systemet at undg√• at generere billeder med b√∏rn i. Det er ikke altid det virker.</li>
                                <li style="margin-bottom: 4px;">For komplekse eller meget specifikke billedprompts kan v√¶re sv√¶re for modellen at fortolke korrekt.</li>
                                <li style="margin-bottom: 4px;">En midlertidig kvotebegr√¶nsning p√• billedgenereringstjenesten.</li>
                            </ul>
                        </li>
                        <li style="margin-bottom: 8px;">
                            <strong>For historier (tekst):</strong>
                            <ul style="list-style-type: circle; margin-top: 4px; padding-left: 20px;">
                                <li style="margin-bottom: 4px;">AI-modellens (Google Gemini) sikkerhedsfiltre kan til tider blokere en historie, hvis den overskrider deres politikker.</li>
                                <li style="margin-bottom: 4px;">Dette kan ske, hvis input tolkes som omhandlende f√∏lsomme emner, vold, hadtale, eller andet indhold, der er i strid med retningslinjerne for brug af AI-modellen, selvom det ikke var din intention.</li>
                                <li style="margin-bottom: 4px;">Pr√∏v at omformulere dine input, is√¶r hvis historien gentagne gange fejler, bliver blokeret eller returnerer uventet indhold.</li>
                            </ul>
                        </li>
                        <li style="margin-bottom: 8px;">
                            <strong>Generelt for b√•de historie og billeder:</strong>
                            <ul style="list-style-type: circle; margin-top: 4px; padding-left: 20px;">
                                <li style="margin-bottom: 4px;">Midlertidige tekniske problemer eller h√∏j belastning p√• de underliggende AI-tjenester kan forekomme.</li>
                                <li style="margin-bottom: 4px;">Meget lange eller ekstremt komplekse input kan nogle gange v√¶re sv√¶rere for AI'en at h√•ndtere optimalt.</li>
                                <li style="margin-bottom: 4px;">Gemini 2.5 pro kan tage mellem 1-3 minutter for at generere en historie.</li>
                            </ul>
                        </li>
                    </ul>
                    <p style="margin-top:12px; font-size:0.9em;"><em>Hvis problemer forts√¶tter, overvej at simplificere dine input <br> eller pr√∏v igen lidt senere eller skriv et feedback.</em></p>
                </div>
            </div>
        </section>

        <section id="billede-til-historien-sektion" class="hidden">
            <h2>Billede til Historien (Beta-version)</h2>
            <div id="image-loading-indicator" class="hidden" style="text-align: center; margin-bottom: 15px;">
                Genererer billede, vent venligst... <span class="spinner"></span>
            </div>
            <div id="generated-image-container" style="text-align: center;">
                <img id="story-image-display" src="#" alt="Genereret billede til historien" class="hidden" style="max-width: 100%; max-height: 500px; height: auto; border-radius: var(--border-radius); margin-top: 10px; border: 1px solid var(--border-color);">
            </div>
            <div id="image-generation-error" class="feedback-status error" style="margin-top: 15px; text-align: center;"></div>
        </section>

        <section id="sangtekster-sektion">
            <h2>Godnatsange</h2>
            <div class="input-category">
                <label for="sang-dropdown">V√¶lg en sang:</label>
                <select name="sang-valg" id="sang-dropdown">
                    <option value="">-- V√¶lg en sang --</option>
                </select>
            </div>
            <div class="input-category">
                <h3 id="sangtekst-titel" style="margin-bottom: 10px; color: var(--color-primary); font-weight: 500;">Sangtekst:</h3>
                <div id="sangtekst-visning" style="background-color: #f9f9f9; padding: 15px; border-radius: var(--border-radius); border: 1px solid var(--border-color); min-height: 80px; white-space: pre-wrap;">
                    V√¶lg en sang fra listen ovenfor for at se teksten her.
                </div>
            </div>
        </section>

        <section id="feedback-section">
             <button type="button" id="toggle-feedback-button" class="utility-button">Giv Feedback / Skjul Feedback</button>
             <div id="feedback-embed-container" class="hidden">
                 <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScNfIyz-0hNlgfKAkJo-ioT99LYqjBRo8tO5HvzoXfjaY0HvA/viewform?embedded=true"
                    width="100%"
                    height="500"
                    frameborder="0"
                    marginheight="0"
                    marginwidth="0">Indl√¶ser‚Ä¶</iframe>
             </div>
        </section>
    </main>

    <div id="cookie-consent-banner" class="hidden">
        <p>Denne side bruger cookies til at forbedre din oplevelse og til analyseform√•l (Google Analytics). Ved at klikke "Accepter" giver du samtykke til brugen af disse cookies. L√¶s mere i vores <a href="{{ url_for('main.privacy_policy') }}">privatlivspolitik</a>.</p>
        <button id="accept-cookies-button" class="utility-button">Accepter</button>
    </div>

    <footer>
        <hr>
        <div class="footer-content">
        <div class="footer-info">
                <p>¬© Read Me A Story 2025 - Historier skabt med AI.</p>
                <p><i>For√¶ldreopsyn anbefales altid under l√¶sning. ;)</i></p>
                <p><a href="{{ url_for('main.privacy_policy') }}" class="footer-link">Privatlivs- og Cookiepolitik</a></p> </div>
            </div>
            <div class="footer-social">
                <p>F√∏lg & Del Appen:</p>
                <a href="https://www.facebook.com/profile.php?id=61576301092618" target="_blank" rel="noopener noreferrer" class="social-link">Find os p√• Facebook</a>
                <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.url_root.strip('/') | urlencode }}" target="_blank" rel="noopener noreferrer" class="social-link">Del p√• LinkedIn</a>
            </div>
        </div>
    </footer>

    <script type="module" src="{{ url_for('static', filename='script.js') }}"></script>

</body>
</html>