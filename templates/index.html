<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <title>Read Me A Story - AI Historie Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-M319LP9Z6P"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      // Konfigurer gtag til ikke at sende page_view automatisk, da vi h√•ndterer det efter cookie samtykke
      gtag('config', 'G-M319LP9Z6P', { 'send_page_view': false });
    </script>
</head>
<body>
 {{ dette_er_en_test_for_at_se_om_denne_fil_bdasdasdasdasddwsaliver_loadet }}
    <header>
        <div class="logo-container">
            <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="Read Me A Story Logo" id="app-logo">
        </div>
        <div class="user-status">
            {% if current_user.is_authenticated %}
                <a href="{{ url_for('auth.logout') }}" class="button-logout utility-button">Log ud</a>
            {% else %}
                {# F√¶lles login/opret bruger knap #}
                <a href="{{ url_for('auth.auth_login') }}" class="button-login utility-button">Login / Opret Bruger</a>
            {% endif %}
        </div>
    </header>

<div class="tab-navigation">
        <button type="button" class="tab-button active" data-tab-target="#generator">H√∏jtl√¶sning</button>
        <button type="button" class="tab-button" data-tab-target="#laesehesten-module">L√¶sehesten</button>
        <button type="button" class="tab-button" data-tab-target="#narrative-support-module">
                Narrativ St√∏tte
                {% if not current_user.is_authenticated or current_user.role != 'premium' %}
                    <span class="icon-lock" title="Kr√¶ver Premium medlemskab">üîí</span>
                {% endif %}
        </button>
        <button type="button" class="tab-button" data-tab-target="#logbook-module">
            Logbog
            {% if not current_user.is_authenticated %}
                <span class="icon-lock" title="Log ind for at se din logbog">üîí</span>
            {% endif %}
        </button>
    </div>
    <main>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages-container">
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">
                            {{ message }}
                            {% if category == 'info' and 'logget ud' in message %}
                                <p class="flash-disclaimer">Det har v√¶re en forn√∏jelse - Til vi ses igen :)</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div id="info-tooltip" class="info-tooltip-box hidden" role="tooltip" aria-live="polite">
            <p id="info-tooltip-text" class="tooltip-text-content"></p>
            <button type="button" id="info-tooltip-close" class="tooltip-close-button" aria-label="Luk">&times;</button>
        </div>

        <section id="generator" class="content-section">
            <h2>Byg jeres historie</h2>
            <p>(Det er ikke n√∏dvendigt at udfylde alle felterne.)</p>

            <div class="input-category">
                <label>Hvem skal historien l√¶ses for?</label>
                <div id="listener-container">
                    <div class="listener-group">
                        <div class="input-pair">
                           <label for="listener-name-1" class="sr-only">Navn</label>
                            <input type="text" name="listener_name_single" id="listener-name-1" placeholder="Barnets Navn">
                        </div>
                        <div class="input-pair">
                           <label for="listener-age-1" class="sr-only">Alder</label>
                            <input type="text" name="listener_age_single" id="listener-age-1" placeholder="Alder (f.eks. 5)">
                        </div>
                         <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                    </div>
                </div>
                <button type="button" id="add-listener-button" class="add-button">+ Tilf√∏j barn</button>
            </div>

            <div class="input-category">
                <label>Hvem skal v√¶re hovedperson(er)?</label>
                <div id="karakter-container">
                    <div class="character-group">
                         <div class="input-pair">
                            <label for="karakter-desc-1" class="sr-only">Beskrivelse</label>
                            <input type="text" name="karakter_desc" id="karakter-desc-1" placeholder="Beskrivelse (f.eks. en modig bi)">
                         </div>
                         <div class="input-pair">
                            <label for="karakter-navn-1" class="sr-only">Navn</label>
                            <input type="text" name="karakter_navn" id="karakter-navn-1" placeholder="Navn (valgfrit)">
                         </div>
                         <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                    </div>
                </div>
                <button type="button" id="add-karakter-button" class="add-button">+ Tilf√∏j karakter</button>
            </div>

            <div class="input-category">
                <label>Hvor skal historien foreg√•?</label>
                <div id="sted-container">
                     <div class="input-group">
                        <input type="text" name="sted" id="sted-input-1" placeholder="f.eks. i en kagebutik, p√• m√•nen">
                        <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                     </div>
                </div>
                <button type="button" class="add-button" data-container="sted-container" data-placeholder="f.eks. under en stor svamp" data-name="sted">+ Tilf√∏j sted</button>
            </div>

            <div class="input-category">
                <label>Ting, h√¶ndelser eller morale?</label>
                <div id="plot-container">
                    <div class="input-group">
                        <input type="text" name="plot" id="plot-input-1" placeholder="f.eks. en magisk fjer, 'at dele er godt'">
                        <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                    </div>
                </div>
                 <button type="button" class="add-button" data-container="plot-container" data-placeholder="f.eks. en hemmelig d√∏r, '√¶rlighed varer l√¶ngst'" data-name="plot">+ Tilf√∏j ting/morale</button>
            </div>

            <div class="input-category">
                <label for="negative-prompt-input">Ting der IKKE skal med i historien:</label>
                <div class="input-group"> <textarea id="negative-prompt-input" name="negative_prompt" rows="3" placeholder="f.eks. 'ingen edderkopper', 'undg√• monstre', 'ikke noget om at falde' (adskil med komma eller linjeskift)"></textarea>
                </div>
            </div>

            <div class="input-category">
                <label for="laengde-select">V√¶lg historie l√¶ngde:</label>
                <select name="laengde" id="laengde-select">
                    <option value="kort" selected>Kort</option>
                    <option value="mellem">Mellem</option>
                    <option value="lang">Lang</option>
                </select>
            </div>

            <div class="input-category">
                <label for="mood-select">V√¶lg stemning:</label>
                <select name="mood" id="mood-select">
                    <option value="neutral" selected>Neutral / Blandet</option>
                    <option value="s√∏d">S√∏d</option>
                    <option value="sjov">Sjov / Humoristisk</option>
                    <option value="eventyr">Eventyrlig</option>
                    <option value="sp√¶ndende">Sp√¶ndende</option>
                    <option value="rolig">Rolig / Afslappende</option>
                    <option value="mystisk">Mystisk</option>
                    <option value="hverdagsdrama">Hverdagsdrama (sm√• konflikter)</option>
                    <option value="uhyggelig">Uhyggelig</option>
                </select>
            </div>

            <div class="input-category" style="display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start; margin-bottom: 0;">

                <div class="switch-option-group" style="flex: 1; min-width: 220px;">
                    <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 6px;">
                        <label for="ai-model-switch" style="font-weight: bold;">Pro AI-Model:</label>
                        <span class="info-icon" data-tooltip-id="pro-model-info" title="Klik for mere info">‚ìò</span>
                    </div>
                    <div class="ai-model-selector-wrapper">
                        <span class="ai-model-choice-label">Standard</span>
                        <div class="switch-container">
                            <input type="checkbox" id="ai-model-switch" name="ai_model_switch"
                                   {% if not current_user.is_authenticated or current_user.role == 'free' %}
                                   disabled
                                   title="Kun for Basic/Premium brugere. Giver adgang til den bedste AI-model."
                                   {% elif current_user.role in ['basic', 'premium'] %}
                                   title="Standard: Hurtig model. Pro: Bedste kvalitet (langsommere)."
                                   {% endif %}>
                            <label for="ai-model-switch" class="slider-label"></label>
                        </div>
                        <span class="ai-model-choice-label">Pro</span>
                    </div>
                </div>

                <div class="switch-option-group" style="flex: 1; min-width: 220px;">
                    <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 6px;">
                        <label for="interactive-story-switch" style="font-weight: bold;">Interaktiv Historie:</label>
                        <span class="info-icon" data-tooltip-id="interactive-info" title="Klik for mere info">‚ìò</span>
                    </div>
                    <div class="ai-model-selector-wrapper">
                        <span class="ai-model-choice-label">Fra</span>
                        <div class="switch-container">
                            <input type="checkbox" id="interactive-story-switch" name="interactive_story_switch"
                                   {% if not current_user.is_authenticated or current_user.role == 'free' %}
                                   disabled
                                   title="Kr√¶ver Pro AI-Model. V√¶lg 'Pro' under 'Pro AI-Model'."
                                   {% else %}
                                   disabled
                                   title="V√¶lg 'Pro' under 'Pro AI-Model' for at aktivere."
                                   {% endif %}
                            >
                            <label for="interactive-story-switch" class="slider-label"></label>
                        </div>
                        <span class="ai-model-choice-label">Til</span>
                    </div>
                    <small class="form-text text-muted" style="display: block; margin-top: 5px; font-size: 0.85em;">

                    </small>
                </div>

                <div class="switch-option-group" style="flex: 1; min-width: 220px;">
                    <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 6px;">
                        <label for="bedtime-story-switch" style="font-weight: bold;">Godnatl√¶sning:</label>
                        <span class="info-icon" data-tooltip-id="bedtime-info" title="Klik for mere info">‚ìò</span>
                    </div>
                    <div class="ai-model-selector-wrapper">
                        <span class="ai-model-choice-label">Fra</span>
                        <div class="switch-container">
                            <input type="checkbox" id="bedtime-story-switch" name="bedtime_story_switch">
                            <label for="bedtime-story-switch" class="slider-label"></label>
                        </div>
                        <span class="ai-model-choice-label">Til</span>
                    </div>
                    <small class="form-text text-muted" style="display: block; margin-top: 5px; font-size: 0.85em; visibility: hidden;">&nbsp;</small>
                </div>
            </div>

            <div class="input-category" style="padding-top: 5px; margin-top: -15px; text-align: left;">
                <small class="form-text text-muted" style="display: block; font-size: 0.85em;">
                    (√ònskes adgang til Basic/Premium, skriv til Philip, da dette pt. er en mekanisme for at beskytte systemet mod uventet meget brug af de dyreste modeller).
                </small>
            </div>

            <div class="input-category" id="tts-voice-selection">
                <label for="tts-voice-select">V√¶lg Stemme til Opl√¶sning:</label>
                <select name="tts_voice" id="tts-voice-select">
                    <option value="Zephyr" selected>Zephyr (Kvinde)</option>
                    <option value="Dansk Kvinde 1 (Standard)">Dansk Kvinde 1 (Standard)</option>
                    <option value="Dansk Mand 1 (Standard)">Dansk Mand 1 (Standard)</option>
                    <option value="Dansk Mand 2 (Standard)">Dansk Mand 2 (Standard)</option>
                    <option value="Dansk Kvinde 2 (Standard)">Dansk Kvinde 2 (Standard)</option>
                </select>
                <small class="form-text text-muted" style="display: block; margin-top: 5px;">
                    Denne stemme er tr√¶net p√• engelsk, hvorfor den kan opf√∏re sig underligt p√• dansk.
                </small>
            </div>

            <div class="generator-actions">
                 <button type="button" id="autofill-button" class="utility-button">Autoudfyld</button>
                <button type="button"
                        id="read-aloud-button"
                        class="utility-button tts-button {% if not current_user.is_authenticated or (current_user.role != 'basic' and current_user.role != 'premium') %}disabled-button{% endif %}"
                        {% if not current_user.is_authenticated or (current_user.role != 'basic' and current_user.role != 'premium') %}disabled title="Login med Basic eller Premium for at aktivere funktionen"{% endif %}
                        data-default-voice="Zephyr"> L√¶s Historien H√∏jt
                </button>
                <button type="button"
                        class="utility-button image-button js-generate-image"
                        disabled> Generer Billede
                </button>
                <div class="font-size-controls">
                    <button type="button" id="decrease-font-button" class="utility-button font-button" title="G√∏r teksten mindre">A-</button>
                    <button type="button" id="increase-font-button" class="utility-button font-button" title="G√∏r teksten st√∏rre">A+</button>
                    <button type="button" id="reset-font-button" class="utility-button font-button" title="Nulstil tekstst√∏rrelse">Nulstil</button>
                </div>
            </div>
            <button id="generate-button">Skab Historie</button>
        </section>

        <section id="laesehesten-module" class="content-section hidden">

            <h2>Byg en historie til dit l√¶seniveau</h2>
            <p>V√¶lg et LIX-tal og nogle elementer fra listerne, s√• skaber AI'en en historie, der passer pr√¶cist til niveauet.</p>

            <div class="input-category">
                <label for="lix-slider" class="lix-label">V√¶lg L√¶se Niveau (LIX): <span id="lix-value-display" class="lix-value">25</span></label>
                <div class="lix-slider-container">
                    <span class="lix-range-label">Let</span>
                    <input type="range" id="lix-slider" name="lix_target" min="5" max="55" value="25" class="lix-slider-style">
                    <span class="lix-range-label">Sv√¶r</span>
                </div>
                <p id="lix-description" class="lix-description-text">Passer til et barn p√• ca. 8-9 √•r, der er ved at v√¶re sikker i sin l√¶sning.</p>
            </div>
            <hr>

            <div class="input-category">
                <label>Sort√©r elementer efter sv√¶rhedsgrad:</label>
                <div class="sort-bar">
                    <button type="button" class="utility-button sort-button active" data-sort="all">Alle</button>
                    <button type="button" class="utility-button sort-button" data-sort="1">Let ‚óè‚óã‚óã</button>
                    <button type="button" class="utility-button sort-button" data-sort="2">Medium ‚óè‚óè‚óã</button>
                    <button type="button" class="utility-button sort-button" data-sort="3">Sv√¶r ‚óè‚óè‚óè</button>
                </div>
            </div>

            <div id="laesehesten-accordion-container">
                </div>

            <hr>

            <div class="input-category">
                <label for="laesehest-focus-letter">Fokus-bogstav (valgfrit):</label>
                <input type="text" id="laesehest-focus-letter" name="laesehest_focus_letter" placeholder="F.eks. 's' for at √∏ve s-lyde, eller 'a, o, i' for vokalfokus" maxlength="10">
            </div>

            <div class="input-category">
                <label>Tilf√∏j dine egne ord eller navne (valgfrit):</label>
                <div id="laesehest-custom-words-container">
                    <div class="input-group">
                        <input type="text" name="laesehest_custom_word" placeholder="f.eks. farmor, Buster, en sej kasket">
                        <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                    </div>
                </div>
                <button type="button" id="laesehest-add-word-button" class="add-button">+ Tilf√∏j ord</button>
            </div>

            <div class="input-category">
                <label for="laesehest-plot">Ting, h√¶ndelser eller morale (valgfrit)?</label>
                <input type="text" id="laesehest-plot" name="laesehest_plot" placeholder="f.eks. en magisk fjer, 'at dele er godt'">
            </div>
            <div class="input-category">
                <label for="laesehest-negative-prompt">Ting der IKKE skal med i historien (valgfrit):</label>
                <textarea id="laesehest-negative-prompt" name="laesehest_negative_prompt" rows="2" placeholder="f.eks. 'ingen edderkopper', 'ikke noget om at falde'"></textarea>
            </div>

            <div class="input-category" style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <label for="laesehest-laengde-select">V√¶lg historie l√¶ngde:</label>
                    <select name="laesehest_laengde" id="laesehest-laengde-select">
                        <option value="kort">Kort</option>
                        <option value="mellem" selected>Mellem</option>
                        <option value="lang">Lang</option>
                    </select>
                </div>
                <div style="flex: 1;">
                    <label for="laesehest-mood-select">V√¶lg stemning:</label>
                    <select name="laesehest_mood" id="laesehest-mood-select">
                        <option value="neutral" selected>Neutral / Blandet</option>
                        <option value="s√∏d">S√∏d</option>
                        <option value="sjov">Sjov</option>
                        <option value="eventyr">Eventyrlig</option>
                        <option value="sp√¶ndende">Sp√¶ndende</option>
                        <option value="rolig">Rolig / Afslappende</option>
                    </select>
                </div>
            </div>

            <div style="text-align: center; margin-top: 25px;">
                {% if current_user.is_authenticated and current_user.role in ['basic', 'premium'] %}
                    <button id="generate-laesehest-button" class="primary-action-button">Skab L√¶sehest-Historie</button>
                {% else %}
                    <button id="generate-laesehest-button-disabled" class="primary-action-button" disabled title="Log ind for at skabe en historie">Skab L√¶sehest-Historie</button>
                    <p style="font-size: 0.9em; margin-top: 10px;">
                        <a href="{{ url_for('auth.auth_login') }}">Log ind</a> eller <a href="{{ url_for('auth.register') }}">opret en bruger</a> for at skabe historier.
                    </p>
                {% endif %}
            </div>
        </section>


        <section id="narrative-support-module" class="content-section hidden">
            {% if current_user.is_authenticated and current_user.role == 'premium' %}
                {# --- START: FULD BRUGERFLADE FOR PREMIUM BRUGERE --- #}
                <h2>Narrativ St√∏tte</h2>
                <p>Skab historier med et specifikt p√¶dagogisk eller f√∏lelsesm√¶ssigt fokus.</p>
                <div class="continuation-flow-section" style="background-color: #f0f8ff; border: 1px solid var(--color-secondary); border-radius: var(--border-radius); padding: 15px; margin-bottom: 25px;">
                    <div class="switch-option-group">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label for="continue-story-switch" style="font-weight: bold; margin-bottom: 0;">Forts√¶t en Historie fra logbogen:</label>
                            <div class="switch-container">
                                <input type="checkbox" id="continue-story-switch" name="continue_story_switch">
                                <label for="continue-story-switch" class="slider-label"></label>
                            </div>
                        </div>
                    </div>

                    <div id="continuation-options" class="hidden" style="margin-top: 15px; border-top: 1px dashed var(--border-color); padding-top: 15px;">
                        <div class="form-group-logbook" style="margin-bottom: 20px;">
                            <label for="parent-story-select">V√¶lg historie at bygge videre p√•:</label>
                            <select id="parent-story-select" name="parent_story_id">
                                <option value="">-- Henter Historier... --</option>
                            </select>
                        </div>

                        <div id="continuation-strategy-selection" class="hidden" style="text-align: center;">
                            <p style="font-weight: bold;">V√¶lg jeres n√¶ste skridt:</p>
                            <div style="display: flex; gap: 15px; justify-content: center;">
                                <button type="button" class="utility-button" name="continuation_strategy" value="deepen" style="background-color: var(--color-secondary);">Dyk Dybere</button>
                                <button type="button" class="utility-button" name="continuation_strategy" value="generalize" style="background-color: var(--color-secondary);">Flyv H√∏jere</button>
                            </div>
                            <div id="continuation-context-box" style="margin-top:15px; text-align:left; font-size: 0.9em;"></div>
                        </div>
                    </div>
                </div>

                <div class="narrative-info-dropdown">
                    <button type="button" class="dropdown-toggle">Hvad er Narrativ Terapi? <span class="dropdown-arrow">&#9664;</span></button>
                    <div class="dropdown-content hidden">
                       <h4>Hvad er narrativ st√∏tte?</h4>
                        <p>Dette modul er inspireret af narrativ terapi. Grundtanken er, at vi mennesker forst√•r vores liv gennem historier. Disse historier er ikke bare passive genfort√¶llinger, men aktive medskabere af vores identitet og hvordan vi ser verden. Ved at √¶ndre historien, kan vi √¶ndre oplevelsen.</p>

                        <h4>Centrale id√©er i modulet</h4>
                        <p><strong>G√∏r problemet til en figur (Externalisering):</strong> Hj√¶lper med at adskille et problem (f.eks. vrede) fra barnets identitet. Forestil dig 'vrede' som en 'vred trold', i stedet for at t√¶nke 'barnet ER vredt'. N√•r problemet f√•r en ydre form (som 'bekymringsdragen'), kan barnet bedre tale om det og arbejde med det. Det mindsker skam og √∏ger f√∏lelsen af kontrol.</p>
                        <p><strong>Find barnets superkr√¶fter (Ressourcer og Styrker):</strong> Modulet fremh√¶ver barnets egne styrker ‚Äì unikke 'superkr√¶fter' som mod, venlighed eller kreativitet. Historierne vil vise, hvordan disse styrker kan bruges til at m√∏de udfordringer.</p>
                        <p><strong>Fremh√¶ver de sm√• sejre (Unikke Udfald):</strong> Vi leder efter √∏jeblikke, hvor problemet <em>ikke</em> havde magten, eller hvor barnet klarede sig p√• en god m√•de. Disse 'sm√• sejre' fremh√¶ves i historien for at vise barnet, at det kan modst√• problemer.</p>
                        <p><strong>Skab en ny, styrkende historie (Re-fort√¶lling):</strong> Ved at flette problemer (som ydre figurer), barnets styrker og de sm√• sejre sammen, skabes en ny, mere positiv og styrkende historie. M√•let er at give barnet en f√∏lelse af kontrol og h√•b, og at skifte fokus fra problemer til l√∏sninger og styrker.</p>

                        <h4>Modulets form√•l</h4>
                        <p>'Narrativ St√∏tte' er et v√¶rkt√∏j til at skabe historier med et p√¶dagogisk eller f√∏lelsesm√¶ssigt sigte. Det hj√¶lper med at:</p>
                        <ul>
                            <li>Ber√∏re sv√¶re temaer p√• en blid m√•de.</li>
                            <li>Inspirere til samtaler via refleksionssp√∏rgsm√•l.</li>
                            <li>Styrke barnets positive tanker om sv√¶re oplevelser.</li>
                            <li>Give for√¶ldre indsigt i narrative principper.</li>
                        </ul>

                        <h4>Vigtigt!</h4>
                        <p><strong>Husk, 'Narrativ St√∏tte' er et inspirationsv√¶rkt√∏j og IKKE en erstatning for professionel terapi eller r√•dgivning. S√∏g altid professionel hj√¶lp ved bekymringer om dit barns trivsel.</strong></p>
                    </div>
                </div>

                <div class="narrative-info-dropdown">
                    <button type="button" class="dropdown-toggle">Vejledning til Narrativ Historiefort√¶lling <span class="dropdown-arrow">&#9664;</span></button>
                    <div class="dropdown-content hidden">
                        <h4>S√•dan f√•r du mest ud af "Narrativ St√∏tte"</h4>
                        <p>Denne guide hj√¶lper dig med at udfylde felterne, s√• AI'en kan skabe den bedst mulige historie for dit barn:</p>
                        <ul>
                            <li>
                                <strong>Begivenhed, Udfordring eller Fokus for Historien (Obligatorisk):</strong>
                                <p>Dette er kernen i historien. Hvad skal den handle om? Det kan v√¶re en f√∏lelse (f.eks. "at v√¶re genert", "jalousi p√• en kammerat"), en konkret udfordring (f.eks. "sv√¶rt ved at falde i s√∏vn alene", "konflikter om leget√∏j") eller en kommende begivenhed, der fylder (f.eks. "skolestart", "at skulle vaccineres", "en for√¶lder skal ud at rejse"). Jo mere specifik du er, jo bedre kan historien tilpasses.</p>
                            </li>
                            <li>
                                <strong>Problem-karakter (Hvad er Eksternalisering?):</strong>
                                <p>I narrativ terapi taler man om "eksternalisering". Det betyder, at man adskiller problemet fra barnet og i stedet ser det som en ydre "figur". I stedet for "Ida ER bange", kan historien handle om, hvordan Ida m√∏der "Frygt-Sp√∏gelset". Dette hj√¶lper barnet med at tale om problemet uden at f√∏le skyld eller skam. Historierne vil automatisk bruge dette princip ved at give udfordringen en ekstern karakter. <br><em>(Bem√¶rk: Selvom du kan foresl√• et navn til problem-karakteren, er det ikke sikkert det kommer med grundet AI'ens logik p√• tv√¶rs af alle inputs.)</em></p>
                            </li>
                            <li>
                                <strong>Barnets Styrker og Ressourcer (Anbefalet):</strong>
                                <p>Ved at fremh√¶ve hvilke positive egenskaber dit barn har (f.eks. modig, fantasifuld, omsorgsfuld, nysgerrig) kan disse aktivt inddrage i historien og vise barnet, hvordan dets egne "superkr√¶fter" kan bruges til at h√•ndtere udfordringen.</p>
                            </li>
                            <li>
                                <strong>√ònsket M√•l for Historien (Anbefalet):</strong>
                                <p>Ved at give et m√•l ud fra problemstillingen, kan hj√¶lpe historien i den retning, hvor der er st√∏rst virkning og dermed give barnet retning mod en bestemt situation. Det skal vise en ny m√•de at t√¶nke om et problem p√• og give en fort√∏stning om at der en vej gennem alle sv√¶re tider. Eksempler: "At Peter f√∏ler sig mere tryg ved at sove selv", "At Maja forst√•r, at det er okay at v√¶re vred", "At give h√•b og vise, at ting kan blive bedre" "At nogen ting kan √¶ndres, men vi godt kan leve med det".</p>
                            </li>
                            <li><strong>Efter Historien: Samtale og Nysgerrighed</strong>
                                <p>Brug de genererede refleksionssp√∏rgsm√•l (eller dine egne) til at starte en samtale. Sp√∏rg √•bent: "Hvad t√¶nkte du om...", "Hvordan tror du [hovedpersonen] havde det?", "Er der noget i historien, du kender fra dig selv?". M√•let er ikke at finde "rigtige" svar, men at √•bne for barnets perspektiv og f√• dem til spejle sig i fort√¶llingen.</p>
                            </li>
                        </ul>
                        <p>Husk, det vigtigste er at skabe et rum for tryghed, forst√•else og f√¶lles opdagelse gennem historiernes magi.</p>
                    </div>
                </div>

                <div class="input-category">
                    <label for="narrative-focus-input">Begivenhed, Udfordring eller Fokus for Historien (Obligatorisk): <span class="info-icon" title="Klik for hj√¶lp" data-tooltip-id="tooltip-narrative-focus">‚ìò</span></label>
                    <textarea id="narrative-focus-input" name="narrative_focus" rows="3" placeholder="Eks: Min datter er m√∏rkerad, Skal starte i skole, Har f√∏lelsen af at v√¶re genert og alene..."></textarea>
                </div>
                <div class="input-category">
                    <label for="narrative-goal-input">√ònsket M√•l for Historien (Anbefalet): <span class="info-icon" title="Klik for hj√¶lp" data-tooltip-id="tooltip-narrative-goal">‚ìò</span></label>
                    <textarea id="narrative-goal-input" name="narrative_goal" rows="2" placeholder="Eks: At barnet f√∏ler sig accepteret, At barnet kan sove ude..."></textarea>
                </div>

                <div class="narrative-info-dropdown">
                    <button type="button" class="dropdown-toggle">Beskriv Barnet <span class="dropdown-arrow">‚óÄ</span></button>
                    <div class="dropdown-content hidden" style="background-color: #fdfdff; padding-top: 20px; border-top: 1px solid var(--border-color);">

                        <div id="narrative-profile-selector-container" class="input-category" style="display: none; background-color: #eef7ff; padding: 15px; border-radius: var(--border-radius); margin-bottom: 20px;">
                            <label for="narrative-profile-select" style="font-weight: bold;">V√¶lg en gemt barneprofil (vil overskrive felterne nedenfor)</label>
                            <select id="narrative-profile-select" name="narrative_profile_select">
                                <option value="">-- Henter profiler... --</option>
                            </select>
                        </div>
                        <div class="input-category">
                            <label>Information om Barnet (Hovedperson):</label>
                            <div id="narrative-child-info-container">
                                <div class="listener-group">
                                    <div class="input-pair">
                                        <label for="narrative-child-name-1" class="sr-only">Barnets Navn</label>
                                        <input type="text" name="narrative_child_name" id="narrative-child-name-1" placeholder="Barnets Navn">
                                    </div>
                                    <div class="input-pair">
                                        <label for="narrative-child-age-1" class="sr-only">Barnets Alder</label>
                                        <input type="text" name="narrative_child_age" id="narrative-child-age-1" placeholder="Alder (f.eks. 6)">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="input-category">
                            <label for="narrative-child-strengths-select">Barnets Karakteristika/Styrker (v√¶lg eller beskriv): <span class="info-icon" title="Klik for hj√¶lp" data-tooltip-id="tooltip-child-strengths">‚ìò</span></label>
                            <select name="narrative_child_strengths_select" id="narrative-child-strengths-select" class="dynamic-select" data-other-input-id="narrative-child-strengths-other">
                                <option value="">-- V√¶lg en styrke --</option><option value="Modig">Modig</option><option value="Klog">Klog</option><option value="Venlig">Venlig</option><option value="Kreativ">Kreativ</option><option value="T√•lmodig">T√•lmodig</option><option value="Nysgerrig">Nysgerrig</option><option value="Omsorgsfuld">Omsorgsfuld</option><option value="Sjov">Sjov</option><option value="St√¶rk">St√¶rk</option><option value="Fantasifuld">Fantasifuld</option><option value="Hj√¶lpsom">Hj√¶lpsom</option><option value="Vedholdende">Vedholdende</option><option value="other">Andet (beskriv nedenfor)...</option>
                            </select>
                            <input type="text" name="narrative_child_strengths_other" id="narrative-child-strengths-other" class="hidden other-input" placeholder="Beskriv anden styrke/karakteristik">
                        </div>
                        <div class="input-category">
                            <label for="narrative-child-values-select">Barnets V√¶rdier/Overbevisninger (valgfri):</label>
                            <select name="narrative_child_values_select" id="narrative-child-values-select" class="dynamic-select" data-other-input-id="narrative-child-values-other">
                                <option value="">-- V√¶lg en v√¶rdi --</option><option value="Retf√¶rdighed">Retf√¶rdighed</option><option value="√Ürlighed">√Ürlighed</option><option value="Empati">Empati</option><option value="Samarbejde">Samarbejde</option><option value="Frihed">Frihed</option><option value="Loyalitet">Loyalitet</option><option value="Omsorg">Omsorg</option><option value="At g√∏re sit bedste">At g√∏re sit bedste</option><option value="other">Andet (beskriv nedenfor)...</option>
                            </select>
                            <input type="text" name="narrative_child_values_other" id="narrative-child-values-other" class="hidden other-input" placeholder="Beskriv anden v√¶rdi/overbevisning">
                        </div>
                        <div class="input-category">
                            <label for="narrative-child-motivation">Barnets Motivation/√ònske (valgfri, udover problemfokus):</label>
                            <input type="text" id="narrative-child-motivation" name="narrative_child_motivation" placeholder="Eks: √ònsker at finde en ven, Vil gerne l√¶re at flyve...">
                        </div>
                        <div class="input-category">
                            <label for="narrative-child-reaction">Barnets Typiske Adf√¶rd/Reaktion p√• Udfordringen (valgfri):</label>
                            <textarea id="narrative-child-reaction" name="narrative_child_reaction" rows="2" placeholder="Eks: Tr√¶kker sig typisk tilbage, Er udadreagerende..."></textarea>
                        </div>
                         <div class="input-category">
                            <label>Vigtige Relationer for Barnet (valgfri):</label>
                            <div id="narrative-relations-container">
                                <div class="relation-group"> <div class="input-pair">
                                       <label for="narrative-relation-name-1" class="sr-only">Relations Navn</label>
                                        <input type="text" name="narrative_relation_name" id="narrative-relation-name-1" placeholder="Navn (f.eks. Bedstemor Anna)">
                                    </div>
                                    <div class="input-pair">
                                       <label for="narrative-relation-type-1" class="sr-only">Relationstype</label>
                                        <input type="text" name="narrative_relation_type" id="narrative-relation-type-1" placeholder="Relation (f.eks. Bedste ven, K√¶ledyr)">
                                    </div>
                                     <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                                </div>
                            </div>
                            <button type="button" id="narrative-add-relation-button" class="add-button">+ Tilf√∏j relation</button>
                        </div>
                    </div>
                </div>

                <div class="narrative-info-dropdown input-category">
                    <button type="button" class="dropdown-toggle">Beskriv Problem-Karakteren (Eksternalisering) <span class="dropdown-arrow">‚óÄ</span></button>
                    <div class="dropdown-content hidden">
                        <div class="narrative-info-dropdown inner-dropdown" style="margin-bottom: 20px; border: 1px dashed var(--color-secondary); background-color: #fdfdfd;">
                            <button type="button" class="dropdown-toggle inner-dropdown-toggle" style="font-size: 0.9em; padding: 8px 12px;">Vejledning: Hvad er Eksternalisering? <span class="dropdown-arrow">‚óÄ</span></button>
                            <div class="dropdown-content inner-dropdown-content hidden" style="padding: 10px 12px;">
                                <p style="font-size: 0.85em; line-height: 1.6;">Eksternalisering er et kerneprincip...</p>
                                <ul style="font-size: 0.85em; line-height: 1.6; padding-left: 18px; margin-bottom: 0;">
                                    <li style="margin-bottom: 5px;"><strong>Giv problemet et navn/en form...</strong></li>
                                    <li style="margin-bottom: 5px;"><strong>Adskil fra barnet...</strong></li>
                                    <li style="margin-bottom: 5px;"><strong>√òget handlekraft...</strong></li>
                                    <li style="margin-bottom: 0px;"><strong>Reducer skam/skyld...</strong></li>
                                </ul>
                                <p style="font-size: 0.85em; line-height: 1.6; margin-top:10px;">N√•r du udfylder felterne...</p>
                            </div>
                        </div>
                        <p style="font-size: 0.85em; color: #555; margin-top: 10px; margin-bottom: 15px;"><em>Dette hj√¶lper AI'en med at give "problemet" en ydre form...</em></p>
                        <div class="input-category" style="margin-bottom:15px;">
                            <label for="narrative-problem-identity-name">Problemets Navn/Identitet:</label>
                            <input type="text" id="narrative-problem-identity-name" name="narrative_problem_identity_name" placeholder="F.eks. Kede-Klodsen, Drille-Sp√∏gelset">
                        </div>
                        <div class="input-category" style="margin-bottom:15px;"><label for="narrative-problem-role-function">Problemets Rolle/Funktion:</label><input type="text" id="narrative-problem-role-function" name="narrative_problem_role_function" placeholder="F.eks. dukker op n√•r ting er sv√¶re"></div>
                        <div class="input-category" style="margin-bottom:15px;"><label for="narrative-problem-purpose-intention">Problemets Form√•l/Intention:</label><input type="text" id="narrative-problem-purpose-intention" name="narrative_problem_purpose_intention" placeholder="F.eks. vil have al opm√¶rksomhed"></div>
                        <div class="input-category" style="margin-bottom:15px;"><label for="narrative-problem-behavior-action">Problemets Typiske Adf√¶rd/Handling:</label><input type="text" id="narrative-problem-behavior-action" name="narrative_problem_behavior_action" placeholder="F.eks. r√•ber h√∏jt, hvisker usynligt"></div>
                        <div class="input-category" style="margin-bottom: 5px;"> <label for="narrative-problem-influence">Problemets Indflydelse p√• Hovedpersonen:</label><input type="text" id="narrative-problem-influence" name="narrative_problem_influence" placeholder="F.eks. g√∏r hovedpersonen ked af det"></div>
                        <div style="margin-top: 15px; text-align: left;"><button type="button" id="narrative-suggest-traits-button" class="utility-button">Foresl√• Karaktertr√¶k (AI)</button></div>
                    </div>
                </div>

                <div class="narrative-info-dropdown">
                    <button type="button" class="dropdown-toggle">Generelle Historieelementer <span class="dropdown-arrow">‚óÄ</span></button>
                    <div class="dropdown-content hidden" style="background-color: #fdfdff; padding-top: 20px; border-top: 1px solid var(--border-color);">
                        <div class="input-category">
                            <label>Hovedkarakter(er) i Historien (udover barnets spejling):</label>
                            <div id="narrative-main-characters-container">
                                <div class="character-group">
                                    <div class="input-pair"><label for="narrative-main-char-desc-1" class="sr-only">Beskrivelse</label><input type="text" name="narrative_main_char_desc" id="narrative-main-char-desc-1" placeholder="Beskrivelse (f.eks. en talende r√¶v)"></div>
                                    <div class="input-pair"><label for="narrative-main-char-name-1" class="sr-only">Navn</label><input type="text" name="narrative_main_char_name" id="narrative-main-char-name-1" placeholder="Navn (valgfrit)"></div>
                                    <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                                </div>
                            </div>
                            <button type="button" id="narrative-add-main-char-button" class="add-button">+ Tilf√∏j hovedkarakter</button>
                        </div>
                        <div class="input-category">
                            <label>Sted(er) hvor historien skal foreg√•:</label>
                            <div id="narrative-places-container">
                                <div class="input-group"><label for="narrative-place-input-1" class="sr-only">Sted</label><input type="text" name="narrative_place" id="narrative-place-input-1" placeholder="f.eks. en hemmelig have, et rumskib"><button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button></div>
                            </div>
                            <button type="button" class="add-button generic-add-button" data-container-id="narrative-places-container" data-input-name="narrative_place" data-input-placeholder="f.eks. under en regnbue" data-input-id-prefix="narrative-place-input">+ Tilf√∏j sted</button>
                        </div>
                        <div class="input-category">
                            <label>Plot-elementer eller √ònsket Morale for historien:</label>
                            <div id="narrative-plot-container">
                                <div class="input-group"><label for="narrative-plot-input-1" class="sr-only">Plot/Morale</label><input type="text" name="narrative_plot" id="narrative-plot-input-1" placeholder="f.eks. en forsvundet skat, 'at v√¶re en god ven'"><button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button></div>
                            </div>
                            <button type="button" class="add-button generic-add-button" data-container-id="narrative-plot-container" data-input-name="narrative_plot" data-input-placeholder="f.eks. en magisk konkurrence" data-input-id-prefix="narrative-plot-input">+ Tilf√∏j plot/morale</button>
                        </div>
                        <div class="input-category">
                            <label for="narrative-negative-prompt-input">Ting der IKKE skal med i historien:</label>
                            <div class="input-group"><textarea id="narrative-negative-prompt-input" name="narrative_negative_prompt" rows="2" placeholder="f.eks. 'ingen hekse', 'undg√• at nogen gr√¶der'"></textarea></div>
                        </div>
                        <div class="input-category">
                            <label for="narrative-mood-select">V√¶lg stemning:</label>
                            <select name="narrative_mood" id="narrative-mood-select">
                                <option value="neutral" selected>Neutral / Blandet</option>
                                <option value="h√•befuld">H√•befuld</option>
                                <option value="t√¶nksom">T√¶nksom</option>
                                <option value="magisk">Magisk</option>
                                <option value="eventyrlig">Eventyrlig</option>
                                <option value="rolig">Rolig / Afslappende</option>
                                <option value="sjov">Sjov / Humoristisk</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="input-category">
                    <label for="narrative-length-select">V√¶lg historie l√¶ngde:</label>
                    <select name="narrative_length" id="narrative-length-select">
                        <option value="kort">Kort</option>
                        <option value="mellem" selected>Mellem</option>
                        <option value="lang">Lang</option>
                    </select>
                </div>
                <hr style="margin: 30px 0;">

                <div class="narrative-actions" style="margin-top: 25px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                    <button type="button" id="narrative-generate-story-button" class="primary-action-button" style="background-color: var(--color-primary); color: white; font-size: 1.1em; padding: 12px 20px;">Generer Narrativ Historie</button>
                     <button type="button" id="narrative-generate-images-button" class="utility-button" disabled title="Generer en historie f√∏rst">Skab Billeder til Fort√¶llingen</button>
                    <div class="font-size-controls" id="narrative-font-size-controls">
                        <button type="button" id="narrative-decrease-font-button" class="utility-button font-button" title="G√∏r teksten mindre">A-</button>
                        <button type="button" id="narrative-increase-font-button" class="utility-button font-button" title="G√∏r teksten st√∏rre">A+</button>
                        <button type="button" id="narrative-reset-font-button" class="utility-button font-button" title="Nulstil tekstst√∏rrelse">Nulstil</button>
                    </div>
                </div>

                <hr style="margin: 30px 0;">

                <div id="narrative-loading-indicator" class="narrative-loading-spinner hidden" style="margin-top: 20px;">
                    Genererer narrativ historie, vent venligst... <span class="spinner"></span>
                </div>
                <div id="narrative-error-display" class="flash-message flash-error hidden" style="margin-top: 20px;"></div>

                <section id="narrative-generated-story-section" class="narrative-output-section hidden">
                    <h2>Historien</h2>
                    <div id="narrative-generated-title" class="narrative-story-title"></div>
                    <div class="narrative-content-box">
                        <div id="narrative-generated-story" class="narrative-story-content-inner">
                            Vent venligst, eller tryk "Generer Narrativ Historie"...
                        </div>
                    </div>
                </section>
                <section id="logbook-documentation-section" class="narrative-info-dropdown hidden">
                    <button type="button" class="dropdown-toggle">Dokumentation og Logbog <span class="dropdown-arrow">‚óÄ</span></button>
                    <div class="dropdown-content hidden">

                        <div id="logbook-analysis-loader" class="narrative-loading-spinner hidden" style="padding: 20px 0;">
                            Analyserer historiens guldkorn... <span class="spinner"></span>
                        </div>

                        <div id="logbook-analysis-error" class="flash-message flash-error hidden"></div>

                        <form id="logbook-entry-form" class="hidden" style="margin-top: 0; padding-top: 10px; border: none; background: none;">
                            <input type="hidden" id="logbook-story-id" name="story_id">

                            <div class="logbook-form-grid">

                                <div class="form-group-logbook full-width">
                                    <label for="logbook-ai-summary">P√¶dagogisk Analyse</label>
                                    <textarea id="logbook-ai-summary" name="ai_summary" rows="5" placeholder="AI-analyse vises her..." style="background-color: #e9ecef; color: #495057; border: 1px solid #ced4da;" readonly></textarea>
                                </div>

                                <div class="form-group-logbook full-width" id="logbook-original-story-container" style="display: none;">
                                    <label for="logbook-original-story-title">Original Historie</label>
                                    <input type="text" id="logbook-original-story-title" name="original_story_title" style="background-color: #e9ecef; color: #495057; border: 1px solid #ced4da; font-style: italic;" readonly>
                                </div>

                                <div class="form-group-logbook">
                                    <label for="logbook-problem-name">Problemets Navn</label>
                                    <input type="text" id="logbook-problem-name" name="problem_name" placeholder="AI-forslag vises her...">
                                </div>
                                <div class="form-group-logbook">
                                    <label for="logbook-problem-category">Problemets Kategori</label>
                                    <input type="text" id="logbook-problem-category" name="problem_category" placeholder="AI-forslag vises her...">
                                </div>
                                <div class="form-group-logbook full-width">
                                    <label for="logbook-problem-influence">Problemets Indflydelse (Hvordan p√•virkede det barnet?)</label>
                                    <textarea id="logbook-problem-influence" name="problem_influence" rows="3" placeholder="AI-forslag vises her..."></textarea>
                                </div>

                                <div class="form-group-logbook full-width">
                                    <label for="logbook-unique-outcome">Helten i Aktion ("Glimtet")</label>
                                    <textarea id="logbook-unique-outcome" name="unique_outcome" rows="4" placeholder="AI-forslag vises her..."></textarea>
                                </div>
                                <div class="form-group-logbook">
                                    <label for="logbook-method-name">Opdaget Metode/Styrke</label>
                                    <textarea id="logbook-method-name" name="discovered_method_name" rows="1" class="single-line-textarea" placeholder="AI-forslag vises her..."></textarea>
                                </div>
                                 <div class="form-group-logbook">
                                    <label for="logbook-strength-type">Styrkens Type</label>
                                    <input type="text" id="logbook-strength-type" name="strength_type" placeholder="AI-forslag vises her...">
                                </div>

                                <div class="form-group-logbook">
                                    <label for="logbook-child-values">Barnets V√¶rdier (f.eks. Mod, Venskab)</label>
                                    <input type="text" id="logbook-child-values" name="child_values" placeholder="AI-forslag vises her...">
                                </div>
                                <div class="form-group-logbook">
                                    <label for="logbook-support-system">St√∏ttesystem ("Vidner")</label>
                                    <input type="text" id="logbook-support-system" name="support_system" placeholder="AI-forslag vises her...">
                                </div>

                                <div class="form-group-logbook full-width">
                                    <label for="logbook-method-steps">Fra Historie til Handling:</label>
                                    <textarea id="logbook-method-steps" name="discovered_method_steps" rows="4" placeholder="Beskriv metoden, s√• I kan huske den..."></textarea>
                                </div>

                                <div class="form-group-logbook full-width">
                                    <label for="logbook-user-notes">Mine Noter (Dine egne tanker og observationer)</label>
                                    <textarea id="logbook-user-notes" name="user_notes" rows="4" placeholder="Tilf√∏j private noter om situationen, barnets reaktion osv."></textarea>
                                </div>
                                <div class="form-group-logbook progress-slider">
                                    <label for="logbook-progress-before">Problemets styrke F√òR (1-10)</label>
                                    <input type="range" id="logbook-progress-before" name="progress_before" min="1" max="10" value="5">
                                    <span class="range-value">5</span>
                                </div>
                                <div class="form-group-logbook progress-slider">
                                    <label for="logbook-progress-after">Problemets styrke EFTER (1-10)</label>
                                    <input type="range" id="logbook-progress-after" name="progress_after" min="1" max="10" value="5">
                                    <span class="range-value">5</span>
                                </div>

                            </div>
                            <button type="submit" id="save-logbook-entry-button" class="primary-action-button" style="margin-top: 20px; width: 100%;">Gem Historien i Logbog</button>
                        </form>
                    </div>
                </section>

                <section id="narrative-reflection-section" class="narrative-output-section hidden">
                    <h2>Refleksionssp√∏rgsm√•l til Opl√¶seren</h2>
                    <div class="narrative-content-box">
                        <ul id="narrative-reflection-questions-list">
                            <li>Sp√∏rgsm√•l vises her efter generering.</li>
                        </ul>
                    </div>
                </section>

                <section id="narrative-debug-section" class="narrative-output-section narrative-info-dropdown hidden">
                    </section>

                {# --- SLUT: FULD BRUGERFLADE FOR PREMIUM BRUGERE --- #}
            {% else %}
                {# --- START: INDIKATOR FOR IKKE-PREMIUM/IKKE-LOGGET IND BRUGERE --- #}
                <div class="premium-feature-notice" style="padding: 20px; text-align: center;">
                    <h2>
                        Narrativ St√∏tte
                        <span class="icon-lock" style="font-size: 0.8em;" title="Kr√¶ver test-login/udviklingsadgang">üîí</span>
                    </h2>

                    <p><strong>Denne funktion er under udvikling.</strong></p>
                    <p>For at f√• adgang til at skabe p√¶dagogisk og f√∏lelsesm√¶ssigt underst√∏ttende historier med "Narrativ St√∏tte"-modulet, kr√¶ves et specifikt test-login, da funktionen pt. er lukket for almindelige brugere, mens den testes og f√¶rdigudvikles.</p>

                    <p style="margin-top: 20px;">
                        <strong>Viden om Narrativ Terapi:</strong><br>
                        <a href="https://psykoterapeutforeningen.dk/psykoterapi/terapiretninger/narrativ-terapi" target="_blank" rel="noopener noreferrer">Beskrivelse af Narrativ Terapi (Psykoterapeutforeningen.dk)</a>
                    </p>

                    <p style="margin-top: 15px;">
                        <strong>Vil du gerne v√¶re med til at teste og udvikle dette modul?</strong><br>
                        S√• skriv til Philip
                    </p>

                    {# KORREKT BLOK TIL LOGIN/ROLLE VISNING #}
                    {% if not current_user.is_authenticated %}
                        <hr style="margin: 25px 0 15px 0;">
                        <p>For at bruge sidens √∏vrige funktioner kan du logge ind:</p>
                        <p style="margin-top: 10px;">
                            <a href="{{ url_for('auth.auth_login') }}" class="button-login utility-button">Login / Opret Bruger</a>
                        </p>
                    {% else %}
                        {# Brugeren ER logget ind, men ikke premium (derfor er vi i denne ydre 'else' blok for narrative-support) #}
                        {# Vi tjekker specifikt for 'free' eller 'basic' her for at give en relevant besked #}
                        {% if current_user.role == 'free' or current_user.role == 'basic' %}
                            <p style="margin-top: 15px;">Din nuv√¶rende rolle er '{{ current_user.role | capitalize }}'. Adgang til Narrativ St√∏tte kr√¶ver Premium.</p>
                        {% endif %}
                    {% endif %}
                    {# SLUT P√Ö KORREKT BLOK TIL LOGIN/ROLLE VISNING #}

                    <p style="margin-top:25px; font-size:0.9em; border-top: 1px solid #eee; padding-top: 15px;">
                        <em>Du kan stadig bruge den almindelige
                            <a href="#" onclick="document.querySelector('.tab-button[data-tab-target=\'#generator\']').click(); return false;">"Godnathistorier"-generator</a>.
                        </em>
                    </p>
                </div>
                {# --- SLUT: INDIKATOR FOR IKKE-PREMIUM/IKKE-LOGGET IND BRUGERE --- #}
            {% endif %} {# Dette er endif for den YDRE if current_user.is_authenticated and current_user.role == 'premium' #}
        </section>

        <section id="logbook-module" class="content-section hidden">
            <div class="logbook-container" style="padding: 0; background: none; box-shadow: none;">
                <h1 style="text-align: center;">Min Logbog</h1>
                <p style="text-align: center; margin-top: -10px; margin-bottom: 25px;">Et bibliotek af personlige sejre og opdagede styrker.</p>

                <section id="profile-management-section" class="narrative-info-dropdown" style="margin-bottom: 30px; border: 1px solid var(--border-color); background-color: #fdfdff;">
<button type="button" class="dropdown-toggle">
                        Mine profiler
                        <span class="dropdown-arrow">‚óÄ</span>
                    </button>
                    <div class="dropdown-content" style="padding: 15px 20px;">
                        <div id="saved-profiles-list" style="margin-bottom: 20px;"></div>

                        <h3 style="color: var(--color-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-bottom: 20px;">Opret Ny / Rediger Profil</h3>

                        <form id="child-profile-form">
                            <input type="hidden" id="profile-id" name="profile_id">

                            <div class="input-category" style="display: flex; gap: 20px;">
                                <div style="flex: 2;">
                                    <label for="profile-name">Barnets Navn</label>
                                    <input type="text" id="profile-name" name="profile_name" placeholder="F.eks. Luna" required>
                                </div>
                                <div style="flex: 1;">
                                    <label for="profile-age">Barnets Alder</label>
                                    <input type="text" id="profile-age" name="profile_age" placeholder="F.eks. 6">
                                </div>
                            </div>

                            <hr style="margin: 25px 0;">

                            <div class="input-category">
                                <label>Barnets Karakteristika/Styrker</label>
                                <div id="profile-strengths-container">
                                    <div class="input-group">
                                        <select name="profile_strength" class="dynamic-select" data-other-input-id="profile-strength-other-1">
                                            <option value="">-- V√¶lg en styrke --</option><option value="Modig">Modig</option><option value="Klog">Klog</option><option value="Venlig">Venlig</option><option value="Kreativ">Kreativ</option><option value="T√•lmodig">T√•lmodig</option><option value="Nysgerrig">Nysgerrig</option><option value="Omsorgsfuld">Omsorgsfuld</option><option value="Sjov">Sjov</option><option value="St√¶rk">St√¶rk</option><option value="Fantasifuld">Fantasifuld</option><option value="Hj√¶lpsom">Hj√¶lpsom</option><option value="Vedholdende">Vedholdende</option><option value="other">Andet...</option>
                                        </select>
                                        <input type="text" name="profile_strength_other" id="profile-strength-other-1" class="hidden other-input" placeholder="Beskriv anden styrke">
                                        <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                                    </div>
                                </div>
                                <button type="button" class="add-button" id="add-profile-strength-button">+ Tilf√∏j styrke</button>
                            </div>

                            <div class="input-category">
                                <label>Barnets V√¶rdier/Overbevisninger</label>
                                <div id="profile-values-container">
                                    <div class="input-group">
                                        <select name="profile_value" class="dynamic-select" data-other-input-id="profile-value-other-1">
                                            <option value="">-- V√¶lg en v√¶rdi --</option><option value="Retf√¶rdighed">Retf√¶rdighed</option><option value="√Ürlighed">√Ürlighed</option><option value="Empati">Empati</option><option value="Samarbejde">Samarbejde</option><option value="Frihed">Frihed</option><option value="Loyalitet">Loyalitet</option><option value="Omsorg">Omsorg</option><option value="At g√∏re sit bedste">At g√∏re sit bedste</option><option value="other">Andet...</option>
                                        </select>
                                        <input type="text" name="profile_value_other" id="profile-value-other-1" class="hidden other-input" placeholder="Beskriv anden v√¶rdi">
                                        <button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button>
                                    </div>
                                </div>
                                <button type="button" class="add-button" id="add-profile-value-button">+ Tilf√∏j v√¶rdi</button>
                            </div>

                            <div class="input-category">
                                <label>Barnets Motivation/√ònske</label>
                                <div id="profile-motivations-container">
                                    <div class="input-group"><input type="text" name="profile_motivation" placeholder="F.eks. Vil gerne l√¶re at cykle"><button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button></div>
                                </div>
                                <button type="button" class="add-button" data-container="profile-motivations-container" data-name="profile_motivation" data-placeholder="F.eks. √ònsker sig en hundehvalp">+ Tilf√∏j motivation</button>
                            </div>

                            <div class="input-category">
                                <label>Barnets Typiske Adf√¶rd/Reaktion p√• Udfordringer</label>
                                <div id="profile-reactions-container">
                                    <div class="input-group"><input type="text" name="profile_reaction" placeholder="F.eks. Bliver stille og tr√¶kker sig"><button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button></div>
                                </div>
                                <button type="button" class="add-button" data-container="profile-reactions-container" data-name="profile_reaction" data-placeholder="F.eks. Stiller mange sp√∏rgsm√•l">+ Tilf√∏j reaktion</button>
                            </div>

                            <div class="input-category">
                                <label>Vigtige Relationer for Barnet</label>
                                <div id="profile-relations-container">
                                    <div class="relation-group"><div class="input-pair"><input type="text" name="profile_relation_name" placeholder="Navn (f.eks. Bedstefar)"></div><div class="input-pair"><input type="text" name="profile_relation_type" placeholder="Relation (f.eks. Superhelt)"></div><button type="button" class="remove-button initial-remove-button" aria-hidden="true">-</button></div>
                                </div>
                                <button type="button" class="add-button" id="add-profile-relation-button">+ Tilf√∏j relation</button>
                            </div>

                            <div style="display: flex; gap: 15px; margin-top: 25px;">
                                <button type="submit" id="save-profile-button" class="primary-action-button" style="flex: 1;">Gem Profil</button>
                                <button type="button" id="clear-profile-form-button" class="utility-button" style="flex: 1; background-color: var(--color-secondary);">Ryd Formular</button>
                            </div>
                            <div id="profile-save-feedback" class="flash-message" style="margin-top: 15px; display: none;"></div>
                        </form>
                    </div>
                </section>

                <div class="logbook-toolbar">
                    <div class="filter-group">
                        <label for="filter-source">Kilde</label>
                        <select name="source" id="filter-source">
                            <option value="all">Alle</option>
                            <option value="Narrativ St√∏tte">Narrativ St√∏tte</option>
                            <option value="H√∏jtl√¶sning">H√∏jtl√¶sning</option>
                            <option value="L√¶sehesten">L√¶sehesten</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="sort-by">Sort√©r efter</label>
                        <select name="sortBy" id="sort-by">
                            <option value="newest">Dato (nyeste)</option>
                            <option value="oldest">Dato (√¶ldste)</option>
                            <option value="title_asc">Titel (A-√Ö)</option>
                            <option value="title_desc">Titel (√Ö-A)</option>
                        </select>
                    </div>
                    <div class="filter-group filter-group-search">
                        <label for="search-term">S√∏g i titel og indhold</label>
                        <input type="search" id="search-term" name="searchTerm" placeholder="S√∏g her...">
                    </div>
                </div>
                <div id="logbook-list-container">
                    {% if stories %}
                        <p>Henter historier...</p>
                    {% else %}
                        <p style="text-align: center;">Du har endnu ikke gemt nogen Historier.</p>
                    {% endif %}
                </div>
            </div>
        </section>

        <section id="historie-output">
            <div class="historie-header-controls">
                <h2 id="story-section-heading">Jeres historie</h2>
                <div class="audio-controls-container">
                    <div id="audio-loading" class="hidden">Genererer lyd, vent venligst... <span class="spinner"></span></div>
                    <div id="audio-error" class="feedback-status error"></div>
                    <div class="login-prompt hidden" id="login-prompt-audio">
                        <em>Du skal v√¶re <a href="{{ url_for('auth.auth_login') }}">logget ind</a> for at f√• l√¶st historien h√∏jt.</em>
                    </div>
                    <audio id="audio-player" controls class="audio-player-style hidden">
                        Din browser underst√∏tter ikke lyd-elementet.
                    </audio>
                </div>
            </div>

            <div id="story-display">
                <div id="story-loading-indicator" class="hidden">
                    <p>Historien genereres... Vent venligst.</p>
                    <span class="spinner"></span>
                </div>
                <div id="story-text-content"></div>
            </div>

            <div id="story-share-buttons" class="hidden">
                <button type="button" id="share-story-facebook-button" class="utility-button">Del p√• Facebook</button>
                <button type="button" id="copy-story-button" class="utility-button">Kopier Historie</button>
                <button id="reset-button" class="utility-button" style="display: none;">Pr√∏v igen</button>
            </div>

            <div class="info-dropdown-container" style="margin-top: 20px; text-align: left; max-width: 100%;">
                <button type="button" class="dropdown-toggle" id="failure-info-dropdown-toggle">
                    Hvorfor fejler min historie/billede nogle gange? <span class="dropdown-arrow">‚óÄ</span>
                </button>
                <div id="failure-info-dropdown-content" class="dropdown-content hidden" style="padding: 12px 15px; border-top: 1px solid var(--border-color); background-color: #fcfcfc;">
                    <p><strong>Mulige √•rsager til at AI-generering kan fejle:</strong></p>
                    <ul style="margin-top: 8px; padding-left: 20px;">
                        <li style="margin-bottom: 8px;">
                            <strong>For billeder:</strong>
                            <ul style="list-style-type: circle; margin-top: 4px; padding-left: 20px;">
                                <li style="margin-bottom: 4px;">AI-modellerne har pt. stramme restriktioner og politikker, der fx forhindrer generering af billeder, som indeholder genkendelige b√∏rn. Derfor pr√∏ver systemet at undg√• at generere billeder med b√∏rn i. Det er ikke altid det virker.</li>
                                <li style="margin-bottom: 4px;">For komplekse eller meget specifikke billedprompts kan v√¶re sv√¶re for modellen at fortolke korrekt.</li>
                                <li style="margin-bottom: 4px;">En midlertidig kvotebegr√¶nsning p√• billedgenereringstjenesten.</li>
                            </ul>
                        </li>
                        <li style="margin-bottom: 8px;">
                            <strong>For historier (tekst):</strong>
                            <ul style="list-style-type: circle; margin-top: 4px; padding-left: 20px;">
                                <li style="margin-bottom: 4px;">AI-modellens (Google Gemini) sikkerhedsfiltre kan til tider blokere en historie, hvis den overskrider deres politikker.</li>
                                <li style="margin-bottom: 4px;">Dette kan ske, hvis input tolkes som omhandlende f√∏lsomme emner, vold, hadtale, eller andet indhold, der er i strid med retningslinjerne for brug af AI-modellen, selvom det ikke var din intention.</li>
                                <li style="margin-bottom: 4px;">Pr√∏v at omformulere dine input, is√¶r hvis historien gentagne gange fejler, bliver blokeret eller returnerer uventet indhold.</li>
                            </ul>
                        </li>
                        <li style="margin-bottom: 8px;">
                            <strong>Generelt for b√•de historie og billeder:</strong>
                            <ul style="list-style-type: circle; margin-top: 4px; padding-left: 20px;">
                                <li style="margin-bottom: 4px;">Midlertidige tekniske problemer eller h√∏j belastning p√• de underliggende AI-tjenester kan forekomme.</li>
                                <li style="margin-bottom: 4px;">Meget lange eller ekstremt komplekse input kan nogle gange v√¶re sv√¶rere for AI'en at h√•ndtere optimalt.</li>
                                <li style="margin-bottom: 4px;">Gemini 2.5 pro kan tage mellem 1-3 minutter for at generere en historie.</li>
                            </ul>
                        </li>
                    </ul>
                    <p style="margin-top:12px; font-size:0.9em;"><em>Hvis problemer forts√¶tter, overvej at simplificere dine input <br> eller pr√∏v igen lidt senere eller skriv et feedback.</em></p>
                </div>
            </div>
        </section>

        <section id="billede-til-historien-sektion" class="hidden">
            <div id="story-image-container" class="image-result-container hidden">
                <h2>Billede til Historien</h2>
                <div class="image-display-wrapper">
                    <div id="story-image-loader" class="image-loader hidden">
                        <p>Visualiserer historien...</p>
                        <span class="spinner"></span>
                    </div>
                    <img id="story-image-display" class="hidden" src="#" alt="Genereret billede der illustrerer en scene fra historien">
                </div>
                <div id="story-image-error" class="flash-message flash-error hidden"></div>
            </div>

            <div id="problem-image-container" class="image-result-container hidden">
                <h2>Billede af Problemet</h2>
                <div class="image-display-wrapper">
                    <div id="problem-image-loader" class="image-loader hidden">
                        <p>Visualiserer problemet...</p>
                        <span class="spinner"></span>
                    </div>
                    <img id="problem-image-display" class="hidden" src="#" alt="Genereret billede der symboliserer problem-karakteren">
                </div>
                <div id="problem-image-error" class="flash-message flash-error hidden"></div>
            </div>
        </section>

        <section id="sangtekster-sektion" class="hidden">
            <h2>Godnatsange</h2>
            <div class="input-category">
                <label for="sang-dropdown">V√¶lg en godnatsang</label>
                <select id="sang-dropdown" name="sang_valg">
                    <option value="">-- V√¶lg en sang --</option>
                    </select>
            </div>
            <div id="sangtekst-output">
                <h3 id="sangtekst-titel">Sangtekst:</h3>
                <div id="sangtekst-visning" style="white-space: pre-wrap; background-color: #f9f9f9; padding: 15px; border-radius: var(--border-radius); border: 1px solid var(--border-color); min-height: 100px;">
                    V√¶lg en sang fra listen ovenfor for at se teksten her.
                </div>
            </div>
        </section>

        <section id="feedback-section">
             <button type="button" id="toggle-feedback-button" class="utility-button">Giv Feedback / Skjul Feedback</button>
             <div id="feedback-embed-container" class="hidden">
                 <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScNfIyz-0hNlgfKAkJo-ioT99LYqjBRo8tO5HvzoXfjaY0HvA/viewform?embedded=true"
                    width="100%"
                    height="500"
                    frameborder="0"
                    marginheight="0"
                    marginwidth="0">Indl√¶ser‚Ä¶</iframe>
         </div>
    </section>
</main>

    <div id="current-user-role-data" data-role="{{ current_user.role if current_user.is_authenticated else 'guest' }}" style="display: none;"></div>

    <div id="cookie-consent-banner" class="hidden">
        <p>Denne side bruger cookies til at forbedre din oplevelse og til analyseform√•l (Google Analytics). Ved at klikke "Accepter" giver du samtykke til brugen af disse cookies. L√¶s mere i vores <a href="{{ url_for('main.privacy_policy') }}">privatlivspolitik</a>.</p>
        <button id="accept-cookies-button" class="utility-button">Accepter</button>
    </div>

    <footer>
        <hr>
        <div class="footer-content">
        <div class="footer-info">
                <p>¬© Read Me A Story 2025 - Historier skabt med AI.</p>
                <p><i>For√¶ldreopsyn anbefales altid under l√¶sning. ;)</i></p>
                <p><a href="{{ url_for('main.privacy_policy') }}" class="footer-link">Privatlivs- og Cookiepolitik</a></p> </div>
            </div>
            <div class="footer-social">
                <p>F√∏lg & Del Appen:</p>
                <a href="https://www.facebook.com/profile.php?id=61576301092618" target="_blank" rel="noopener noreferrer" class="social-link">Find os p√• Facebook</a>
                <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.url_root.strip('/') | urlencode }}" target="_blank" rel="noopener noreferrer" class="social-link">Del p√• LinkedIn</a>
            </div>
        </div>
    </footer>

    <script type="module" src="{{ url_for('static', filename='script.js') }}"></script>

</body>
</html>